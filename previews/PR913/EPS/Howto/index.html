<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Howto Â· Harmonie wiki</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-HQ1BCP3LPJ"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HQ1BCP3LPJ', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://hirlam.github.io/HarmonieSystemDocumentation/dev/EPS/Howto/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Harmonie wiki logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Harmonie wiki</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../System/GitDeveloperDocumentation/">GitHub workflow</a></li><li><a class="tocitem" href="../../Overview/da_graph/">Graphical Overview</a></li><li><a class="tocitem" href="../../System/ECMWF/RunningHarmonieOnAtos/">Running on Atos</a></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Overview</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Overview/Content/">Content</a></li><li><a class="tocitem" href="../../Overview/Binaries/">Binaries</a></li><li><a class="tocitem" href="../../Overview/FileFormats/">File Formats</a></li><li><a class="tocitem" href="../../Overview/Source/">Source</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-5" type="checkbox"/><label class="tocitem" for="menuitem-2-5"><span class="docs-label">Experiment Configuration</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ExperimentConfiguration/ConfigureYourExperiment/">Experiment</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/Namelists/">Namelist</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/UseofObservation/">Observations</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/PlatformConfiguration/">Platform</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/How_to_use_hires_topography/">HiRes Topography</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/ModelDomain/">Domain</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/VerticalGrid/">Vertical Grid</a></li></ul></li></ul></li><li><span class="tocitem">NWP Components</span><ul><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Observations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1-1"><span class="docs-label">Preprocessing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Observations/ObservationPreprocessing/">Preprocessing</a></li><li><a class="tocitem" href="../../Observations/Oulan/">Oulan</a></li><li><a class="tocitem" href="../../Observations/Bator/">Bator</a></li><li><a class="tocitem" href="../../Observations/Cope/">Cope</a></li><li><a class="tocitem" href="../../Observations/ObservationData/">ObservationData</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-1-2" type="checkbox"/><label class="tocitem" for="menuitem-3-1-2"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Observations/SYNOP/">SYNOP</a></li><li><a class="tocitem" href="../../Observations/Amv/">AMV</a></li><li><a class="tocitem" href="../../Observations/Atovs/">ATOVS</a></li><li><a class="tocitem" href="../../Observations/Iasi/">IASI</a></li><li><a class="tocitem" href="../../Observations/Seviri/">SEVIRI</a></li><li><a class="tocitem" href="../../Observations/Scatt/">Scatt</a></li><li><a class="tocitem" href="../../Observations/Ascat/">AScat</a></li><li><a class="tocitem" href="../../Observations/GNSS/">GNSS</a></li><li><a class="tocitem" href="../../Observations/Modes/">Modes</a></li><li><a class="tocitem" href="../../Observations/RadarData/">Radar</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Data Assimilation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-2-1" type="checkbox"/><label class="tocitem" for="menuitem-3-2-1"><span class="docs-label">Surface</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI/">CANARI</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI_OI_MAIN/">CANARI OI MAIN</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI_EKF_SURFEX/">CANARI EKF SURFEX</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/SurfaceAnalysis/">Surface Analysis</a></li></ul></li><li><a class="tocitem" href="../../DataAssimilation/Screening/">Screening</a></li><li><a class="tocitem" href="../../DataAssimilation/StructureFunctions/">Structure functions</a></li><li><a class="tocitem" href="../../DataAssimilation/DaAlgorithms/">Algorithms</a></li><li><a class="tocitem" href="../../DataAssimilation/DigitalFilterInitialization/">Digital Filter Initialization</a></li><li><a class="tocitem" href="../../DataAssimilation/ObservationOperators/">HOP_DRIVER</a></li><li><a class="tocitem" href="../../DataAssimilation/SingleObs/">Single Obs</a></li><li><a class="tocitem" href="../../DataAssimilation/LSMIXandJk/">LSMIX and Jk</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-3-1"><span class="docs-label">Data Assimilation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DataAssimilation/DFS/">DFS</a></li><li><a class="tocitem" href="../../DataAssimilation/MTEN/">MTEN</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-3-2"><span class="docs-label">Forecast(spin-up)</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DataAssimilation/CHKEVO/">CHKEVO</a></li><li><a class="tocitem" href="../../DataAssimilation/NWECHKEVO/">NWECHKEVO</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Boundaries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Boundaries/BoundaryFilePreparation/">Preparation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Forecast Model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ForecastModel/Forecast/">Forecast</a></li><li><a class="tocitem" href="../../ForecastModel/ForecastSettings/">Settings</a></li><li><a class="tocitem" href="../../ForecastModel/Outputlist/">Output List</a></li><li><a class="tocitem" href="../../ForecastModel/HR/">High Res</a></li><li><input class="collapse-toggle" id="menuitem-3-5-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5-5"><span class="docs-label">Single Column Model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC/">MUSC</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/Forcing/">Forcing</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC_vars/">MUSC vars</a></li></ul></li><li><a class="tocitem" href="../../ForecastModel/WindFarms/">Wind Farm Parameterisation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">Climate Generation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ClimateGeneration/ClimateGeneration/">Climate Generation</a></li><li><a class="tocitem" href="../../ClimateGeneration/DownloadInputData/">Input Data</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-7" type="checkbox" checked/><label class="tocitem" for="menuitem-3-7"><span class="docs-label">EPS</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Howto</a><ul class="internal"><li><a class="tocitem" href="#Simple-configuration"><span>Simple configuration</span></a></li><li><a class="tocitem" href="#Advanced-configuration,-member-specific-settings"><span>Advanced configuration, member specific settings</span></a></li><li><a class="tocitem" href="#An-example"><span>An example</span></a></li><li><a class="tocitem" href="#Further-reading"><span>Further reading</span></a></li></ul></li><li><a class="tocitem" href="../System/">System</a></li><li><a class="tocitem" href="../BDSTRATEGY/">BDSTRATEGY</a></li><li><a class="tocitem" href="../SLAF/">SLAF</a></li><li><a class="tocitem" href="../SPP/">SPP</a></li><li><a class="tocitem" href="../SPPT/">SPPT</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-8" type="checkbox"/><label class="tocitem" for="menuitem-3-8"><span class="docs-label">Post Processing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../PostProcessing/Diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../../PostProcessing/FileConversions/">FileConversions</a></li><li><a class="tocitem" href="../../PostProcessing/Fullpos/">FullPos</a></li><li><a class="tocitem" href="../../PostProcessing/gl/">GL</a></li><li><a class="tocitem" href="../../PostProcessing/xtool/">xtool</a></li><li><a class="tocitem" href="../../PostProcessing/Interpolation/">Interpolation GL</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-9" type="checkbox"/><label class="tocitem" for="menuitem-3-9"><span class="docs-label">Verification</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Verification/Extract4verification/">Extract4verification</a></li><li><a class="tocitem" href="../../Verification/Verification/">Verification</a></li><li><a class="tocitem" href="../../Verification/HARP/">HARP</a></li><li><a class="tocitem" href="../../Verification/Obsmon/">Obsmon</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-10" type="checkbox"/><label class="tocitem" for="menuitem-3-10"><span class="docs-label">Visualization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Visualization/EPyGrAM/">EpyGram</a></li></ul></li></ul></li><li><span class="tocitem">System</span><ul><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Build</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Build/Build_with_cmake/">CMake</a></li><li><a class="tocitem" href="../../Build/Build_with_makeup/">Makeup</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Phasing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../System/MFaccess/">MF Access</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Suite Management</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../SuiteManagement/ECFLOW/">ECFLOW</a></li></ul></li><li><a class="tocitem" href="../../System/TheHarmonieScript/">The Harmonie script</a></li><li><a class="tocitem" href="../../System/ECMWF/RunningHarmonieOnAtos/">Running on ECMWF&#39;s Atos</a></li><li><a class="tocitem" href="../../System/ReleaseProcess/">Harmonie release process</a></li><li><a class="tocitem" href="../../System/Local/QuickStartLocal/">Local</a></li><li><a class="tocitem" href="../../System/HarmonieTestbed/">Testbed</a></li><li><a class="tocitem" href="../../System/ECMWF/ECMWF_teleport/">Teleport</a></li><li><a class="tocitem" href="../../System/Build_local_docs/">Local Documentation</a></li><li><a class="tocitem" href="../../System/DrHook/">DrHook</a></li><li><a class="tocitem" href="../../System/StandaloneOdb/">Stand alone ODB</a></li><li><a class="tocitem" href="../../System/UpdateNamelists/">Update Namelist</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">NWP Components</a></li><li><a class="is-disabled">EPS</a></li><li class="is-active"><a href>Howto</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Howto</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Hirlam/Harmonie/blob/dev-CY46h1/docs/src/EPS/Howto.md" title="Edit on GitHub"><span class="docs-icon fab">ï</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="eps-howto"><a class="docs-heading-anchor" href="#eps-howto">How to run an ensemble experiment</a><a id="eps-howto-1"></a><a class="docs-heading-anchor-permalink" href="#eps-howto" title="Permalink"></a></h1><h2 id="Simple-configuration"><a class="docs-heading-anchor" href="#Simple-configuration">Simple configuration</a><a id="Simple-configuration-1"></a><a class="docs-heading-anchor-permalink" href="#Simple-configuration" title="Permalink"></a></h2><p>Running an ensemble experiment is not very different from running a deterministic one. The basic instructions about setup are the same and will not be repeated here. </p><p>What is different is that in <code>ecf/config_exp.h</code> one needs to pay attention to this particular section:</p><pre><code class="language-bash hljs"># *** Ensemble mode general settings. ***
# *** For member specific settings use msms/harmonie.pm ***
ENSMSEL=                                # Ensemble member selection, comma separated list, and/or range(s):
                                        # m1,m2,m3-m4,m5-m6:step    mb-me == mb-me:1 == mb,mb+1,mb+2,...,me
                                        # 0=control. ENSMFIRST, ENSMLAST, ENSSIZE derived automatically from ENSMSEL.
ENSINIPERT=                             # Ensemble perturbation method (bnd). Not yet implemented: etkf, hmsv, slaf.
ENSCTL=                                 # Which member is my control member? Needed for ENSINIPERT=bnd. See harmonie.pm.
ENSBDMBR=                               # Which host member is used for my boundaries? Use harmonie.pm to set.
ENSMFAIL=                               # Failure tolerance for all members. Not yet implemented.
ENSMDAFAIL=                             # Failure tolerance for members doing own DA. Not yet implemented.</code></pre><p>In addition one should also look at <code>BDSTRATEGY</code>, choose <code>eps_ec</code> if you want to use EC EPS at the boundaries (this option gets the EC EPS data from the GLAMEPS ECFS archive). If you want to use SLAF see <a href="../SLAF/#slaf">here</a>.</p><p>What really triggers EPS mode is having a non-empty ENSMSEL (ensemble member selection). The reason the specification looks a bit complicated is that our ensemble members do not necessarily have to be numbered consecutively from 0 or 1 and up, but can also be specified with steps. The rationale behind this is that we may want to e.g. downscale a subset of the 51 ECMWF EPS members, but not necessarily starting from their lowest number or taking them consecutively. ENSMSEL is a heritage from the Hirlam EPS system and has been retained in Harmonie.</p><p>In the simplest case of consecutive numbering, say we want a control run (member 0) and 20 perturbed members. We can then put</p><pre><code class="language-bash hljs">ENSMSEL=0-20</code></pre><p>Now assume that we still have a control and 20 members, but that we want to take only every second pair of the host EPS members, i.e., take 0,1,2, skip 3,4, take 5,6, skip 7,8 and so on. The following specifications are then equivalent:</p><pre><code class="language-bash hljs">ENSMSEL=0,1,2,5,6,9,10,13,14,17,18,21,22,25,26,29,30,33,34,37,38
ENSMSEL=0,1-37:4,2-38:4</code></pre><p>In the second version we use the step option, so our list is 0, 1 to 37 in steps of 4 and 2 to 38 in steps of 4. The system will take care of transforming this into an ascending list for easier handling within the script system, but we don&#39;t have to worry about that.</p><p>The <code>ENSMSEL</code> selection is still not totally flexible. It would not be possible to have more than one of our members having boundaries from the same member of the host model. This might be relevant in the case of multiple physics, and multiple control members. For this reason the variable <code>ENSBDMBR</code> has also been added (in [10953]). The usage of this variable is explained in the next section (advanced configuration).</p><p>For the rest of the ENS... variables, not everything planned is implemented by the time of this writing. The only valid choice (except empty) for <code>ENSINIPERT</code> (initial state perturbation method) is &quot;bnd&quot;. This option means to take the perturbations of the first (interpolated) boundary file, and add these perturbations to a reference (control) analysis. This will involve the script <code>scr/PertAna</code>, a section of its header is quoted below:</p><pre><code class="language-bash hljs">#| Different perturbation methods are distinguished by
#| ENSINIPERT. This script implements ENSINIPERT=bnd
#|
#| bnd: boundary data mode
#|      an($ENSMBR) = an(cntrl) + bnd1($ENSMBR) - bnd1(cntrl)
#|           where bnd1 denotes the first boundary file</code></pre><p>Which member is the control member is specified by the variable <code>ENSCTL</code>.</p><p>But how to specify that one (or more) member(s) run assimilation and others do not, or in other words, how to specify member specific values to the variables in <code>config_exp.h</code>? This is the topic of the next section.</p><h2 id="Advanced-configuration,-member-specific-settings"><a class="docs-heading-anchor" href="#Advanced-configuration,-member-specific-settings">Advanced configuration, member specific settings</a><a id="Advanced-configuration,-member-specific-settings-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-configuration,-member-specific-settings" title="Permalink"></a></h2><p>It would perhaps have been possible to also have member specific configuration in <code>config_exp.h</code>, but since perl is more flexible with lists than the shell, and since perl is already used extensively in the Harmonie system, it was decided to extend the handling of the template definition files in mini-SMS in such a way that every tdf can now also have an associated perl module to help in its interpretation. And, since after the changesets [10930] and [10932] there is <em>no separate tdf</em> for HarmonEPS anymore (<code>harmonie.tdf</code> is used also for EPS runs), the file that is used for member specific settings is thus <code>msms/harmonie.pm</code>.</p><p>The idea of <code>harmonie.pm</code> is to be able to override some of the environment variables of <code>config_exp.h</code> with new values for selected members of the ensemble. This is achieved by populating the perl hash <code>%env</code> with <code>key =&gt; value</code> pairs. The keys are names of environment variables, like <code>ANAATMO</code>, <code>ANASURF</code>, <code>PHYSICS</code> etc. Only names that are present and exported in <code>config_exp.h</code> should be used as keys. Values can take four different forms:</p><ul><li>A hash, i.e., a new set of <code>key =&gt; value</code> pairs. The syntax in this case is <code>{ m1 =&gt; val1, m2 =&gt; val2, ... }</code>. The numbers <code>m1</code>, <code>m2</code>, etc. must be member numbers given in <code>ENSMSEL</code>. Order is irrelevant, and only members with values different from the default need be listed of course.</li><li>An array, where indices implicitly run from 0 and up. The syntax in this case is <code>[ val0, val1, val2, ...]</code>. Here the array should have as many values as members given in <code>ENSMSEL</code>, but if not, missing values will be recycled from the start of the array (as many times as necessary). Thus, using arrays will give values to all members, and order is important.</li><li>A scalar (string). This string is subject to variable substitution, i.e., any occurrence of the substring <code>@EEE@</code> will be replaced by the relevant 3-digit ensemble member number.</li><li>A subroutine (reference), syntax is typically <code>sub { my $mbr = shift; return &quot;something dependent on $mbr&quot;; }</code>. The arguments given to the subroutine are the &quot;args&quot; of the invoking <code>&amp;Env(&#39;SOMEVAR&#39;,args)</code> call (see below).</li></ul><p>In addition to the hash <code>%env</code>, <code>harmonie.pm</code> also contains a subroutine <code>Env</code>. In <code>msms/harmonie.tdf</code> many earlier occurences of <code>$ENV{SOMEVAR}</code> have now been replaced by subroutine calls <code>&amp;Env(&#39;SOMEVAR&#39;,&#39;@EEE@&#39;)</code>. The <code>@EEE@</code> argument will be replaced by the relevant member number before invocation, and <code>Env</code> will check the hash <code>%env</code> for a member specific setting to possibly return instead of the default value <code>$ENV{SOMEVAR}</code>. There should normally be no need to make changes to the subroutine <code>Env</code>, putting entries into the hash <code>%env</code> ought to be enough.</p><p>Note also that not every occurrence of <code>$ENV{...}</code> has been replaced by a corresponding <code>&amp;Env(...)</code> in <code>harmonie.tdf</code>, only those variables that are most likely to have variations among members are changed. If you need variations in e.g. <code>$HOST_MODEL</code>, then harmonie.tdf needs to be updated so that those variations are respected within the ensemble (EEE) loops.</p><h2 id="An-example"><a class="docs-heading-anchor" href="#An-example">An example</a><a id="An-example-1"></a><a class="docs-heading-anchor-permalink" href="#An-example" title="Permalink"></a></h2><p>We will now look at one particular example, in order to (hopefully) make the descriptions above a bit more clear. Our intent is to have an ensemble with a mix of members with AROME and ALARO physics, with one control member and 10 perturbed members for each. The control members will both do their own 3DVAR assimilation, while perturbed members will have <code>ANAATMO=blending</code>. But with <code>ENSINIPERT=bnd</code>, the control analysis will be used also by the perturbed members. All members will do surface assimilation, but the forecast interval differs. The control members have a forecast interval of 6 hours (because of the 3D-Var), while the perturbed members have <code>FCINT=12</code>. To achieve this, we have the following settings in <code>config_exp.h</code>:</p><pre><code class="language-bash hljs">ANAATMO=blending
ANASURF=CANARI_OI_MAIN
FCINT=12
BDSTRATEGY=eps_ec
ENSMSEL=0-21
ENSINIPERT=bnd
ENSCTL=
ENSBDMBR=</code></pre><p>In <code>harmonie.pm</code> our <code>%env</code> looks as follows:</p><pre><code class="language-bash hljs">%env = (
   &#39;ANAATMO&#39; =&gt; { 0 =&gt; &#39;3DVAR&#39;, 1 =&gt; &#39;3DVAR&#39; },
   &#39;FCINT&#39;   =&gt; { 0 =&gt; 6,       1 =&gt; 6 },
   &#39;PHYSICS&#39; =&gt; [ &#39;arome&#39;,&#39;alaro&#39;,&#39;alaro&#39;,&#39;arome&#39;],
   &#39;ENSCTL&#39;  =&gt; [ &#39;000&#39;,  &#39;001&#39;,  &#39;001&#39;,  &#39;000&#39;],
   &#39;ENSBDMBR&#39; =&gt; [ 0, 0, 1..20],

### Normally NO NEED to change the variables below
   &#39;ARCHIVE&#39; =&gt; &#39;${ARCHIVE}mbr@EEE@/&#39;,
   &#39;CLIMDIR&#39; =&gt; &#39;$CLIMDIR/mbr@EEE@&#39;,
   &#39;OBDIR&#39; =&gt; &#39;$OBDIR/mbr@EEE@&#39;,
   &#39;VFLDEXP&#39; =&gt; &#39;${EXP}mbr@EEE@&#39;,
   &#39;BDDIR&#39; =&gt; sub { my $mbr = shift;
                    if ($ENV{COMPCENTRE} eq &#39;ECMWF&#39;) {
                       return &#39;$BDDIR/mbr&#39;.sprintf(&#39;%03d&#39;,$mbr);
                    } else {
                       return &#39;$BDDIR/mbr&#39;.sprintf(&#39;%03d&#39;,&amp;Env(&#39;ENSBDMBR&#39;,$mbr));
                    }
                  },
   &#39;FirstHour&#39; =&gt; sub { my $mbr = shift;
                        return $ENV{StartHour} % &amp;Env(&#39;FCINT&#39;,$mbr);
                      }
    );</code></pre><p><code>ANAATMO</code> is straightforward, only the control members need an exception from <em>blending</em>, so using a hash is most appropriate. Similarly for <code>FCINT</code>. For <code>PHYSICS</code> we have used an array and the fact that the array will be recycled. Thus member 0 will be the AROME control, while member 1 will be the ALARO control. The reason why we did not simply put a 2-element array [ &#39;arome&#39;,&#39;alaro&#39;] to be repeated is that since the ECMWF perturbations come in +/- pairs, we don&#39;t want all the &#39;+&#39; perturbations to be always with the same physics (and the &#39;-&#39; perturbations with the other type). Therefore, we added a second pair with the order reversed, to alternate +/- perturbations between AROME and ALARO members. <code>ENSCTL</code> follows the same pattern as <code>PHYSICS</code>. Note the need for 3-digit numbers in <code>ENSCTL</code>, at present this is necessary to avoid parsing errors in the preparation step of mini-SMS.</p><p>Note also how we have used <code>ENSBDMBR</code>. For both the AROME control (member 0) and ALARO control (member 1), we have used the EC EPS control member 0 to provide boundaries. The syntax 1..20 is a perl shorthand for the list 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20.</p><p>Note added after changeset [12537]: The setting of <code>ENSBDMBR</code> created a race condition in the boundary extraction for runs at ECMWF. This is hopefully solved by the new definition for <code>BDDIR</code>, which makes use of the possibility of having a subroutine to compute the member specific settings. Another example where a subroutine came out handy was for the setting of <code>FirstHour</code>.</p><h2 id="Further-reading"><a class="docs-heading-anchor" href="#Further-reading">Further reading</a><a id="Further-reading-1"></a><a class="docs-heading-anchor-permalink" href="#Further-reading" title="Permalink"></a></h2><p>More specific instructions and information about known problems can be found <a href="../Setup/#eps-setup">here</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../ClimateGeneration/DownloadInputData/">Â« Input Data</a><a class="docs-footer-nextpage" href="../System/">System Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Thursday 13 July 2023 12:58">Thursday 13 July 2023</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
