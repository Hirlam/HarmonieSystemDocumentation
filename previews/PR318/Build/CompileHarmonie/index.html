<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Compile Harmonie Â· Harmonie wiki</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-221448594-1"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-221448594-1', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://hirlam.github.io/HarmonieSystemDocumentation/dev/Build/CompileHarmonie/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Harmonie wiki logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Harmonie wiki</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../System/GitDeveloperDocumentation/">GitHub workflow</a></li><li><a class="tocitem" href="../../Overview/da_graph/">Graphical Overview</a></li><li><input class="collapse-toggle" id="menuitem-2-3" type="checkbox"/><label class="tocitem" for="menuitem-2-3"><span class="docs-label">Overview</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Overview/Content/">Content</a></li><li><a class="tocitem" href="../../Overview/Binaries/">Binaries</a></li><li><a class="tocitem" href="../../Overview/FileFormats/">File Formats</a></li><li><a class="tocitem" href="../../Overview/Source/">Source</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Quick Start</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../QuickStart/TheHarmonieScript/">The Harmonie script</a></li><li><input class="collapse-toggle" id="menuitem-2-4-2" type="checkbox"/><label class="tocitem" for="menuitem-2-4-2"><span class="docs-label">ECMWF</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../QuickStart/Fast_start_on_cca/">Fast start on cca</a></li></ul></li><li><a class="tocitem" href="../../QuickStart/QuickStartLocal/">Local</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-5" type="checkbox"/><label class="tocitem" for="menuitem-2-5"><span class="docs-label">Experiment Configuration</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ExperimentConfiguration/ConfigureYourExperiment/">Experiment</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/Namelists/">Namelist</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/UseofObservation/">Observations</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/PlatformConfiguration/">Platform</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/How_to_use_hires_topography/">HiRes Topography</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/ModelDomain/">Domain</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/VerticalGrid/">Vertical Grid</a></li></ul></li></ul></li><li><span class="tocitem">NWP Components</span><ul><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Observations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1-1"><span class="docs-label">Preprocessing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Observations/ObservationPreprocessing/">Preprocessing</a></li><li><a class="tocitem" href="../../Observations/Oulan/">Oulan</a></li><li><a class="tocitem" href="../../Observations/Bator/">Bator</a></li><li><a class="tocitem" href="../../Observations/Cope/">Cope</a></li><li><a class="tocitem" href="../../Observations/ObservationData/">ObservationData</a></li><li><a class="tocitem" href="../../Observations/Conrad/">Conrad</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-1-2" type="checkbox"/><label class="tocitem" for="menuitem-3-1-2"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Observations/SYNOP/">SYNOP</a></li><li><a class="tocitem" href="../../Observations/Amv/">AMV</a></li><li><a class="tocitem" href="../../Observations/Iasi/">IASI</a></li><li><a class="tocitem" href="../../Observations/Atovs/">ATOVS</a></li><li><a class="tocitem" href="../../Observations/Scatt/">Scatt</a></li><li><a class="tocitem" href="../../Observations/Ascat/">AScat</a></li><li><a class="tocitem" href="../../Observations/GNSS/">GNSS</a></li><li><a class="tocitem" href="../../Observations/Modes/">Modes</a></li><li><a class="tocitem" href="../../Observations/RadarData/">Radar</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Data Assimilation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-2-1" type="checkbox"/><label class="tocitem" for="menuitem-3-2-1"><span class="docs-label">Surface</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI/">CANARI</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI_OI_MAIN/">CANARI OI MAIN</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI_EKF_SURFEX/">CANARI EKF SURFEX</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/SurfaceAnalysis/">Surface Analysis</a></li></ul></li><li><a class="tocitem" href="../../DataAssimilation/Screening/">Screening</a></li><li><a class="tocitem" href="../../DataAssimilation/StructureFunctions/">Structure functions</a></li><li><a class="tocitem" href="../../DataAssimilation/DataAssimilation4DVAR/">4DVAR</a></li><li><a class="tocitem" href="../../DataAssimilation/DigitalFilterInitialization/">Digital Filter Initialization</a></li><li><a class="tocitem" href="../../DataAssimilation/ObservationOperators/">HOP_DRIVER</a></li><li><a class="tocitem" href="../../DataAssimilation/SingleObs/">Single Obs</a></li><li><a class="tocitem" href="../../DataAssimilation/LSMIXandJk/">LSMIX and Jk</a></li><li><a class="tocitem" href="../../DataAssimilation/DFS/">DFS</a></li><li><a class="tocitem" href="../../DataAssimilation/MTEN/">MTEN</a></li><li><a class="tocitem" href="../../DataAssimilation/CHKEVO/">CHKEVO</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Boundaries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Boundaries/BoundaryFilePreparation/">Preparation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Forecast Model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ForecastModel/Forecast/">Forecast</a></li><li><a class="tocitem" href="../../ForecastModel/Outputlist/">Output List</a></li><li><a class="tocitem" href="../../ForecastModel/HR/">High Res</a></li><li><input class="collapse-toggle" id="menuitem-3-4-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4-4"><span class="docs-label">Single Column Model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC/">MUSC</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/Forcing/">Forcing</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC_vars/">MUSC vars</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Climate Generation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ClimateGeneration/ClimateGeneration/">Climate Generation</a></li><li><a class="tocitem" href="../../ClimateGeneration/DownloadInputData/">Input Data</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">EPS</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../EPS/Howto/">Howto</a></li><li><a class="tocitem" href="../../EPS/System/">System</a></li><li><a class="tocitem" href="../../EPS/BDSTRATEGY/">BDSTRATEGY</a></li><li><a class="tocitem" href="../../EPS/SLAF/">SLAF</a></li><li><a class="tocitem" href="../../EPS/SPP/">SPP</a></li><li><a class="tocitem" href="../../EPS/SPPT/">SPPT</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-7" type="checkbox"/><label class="tocitem" for="menuitem-3-7"><span class="docs-label">Post Processing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../PostProcessing/Diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../../PostProcessing/FileConversions/">FileConversions</a></li><li><a class="tocitem" href="../../PostProcessing/Fullpos/">FullPos</a></li><li><a class="tocitem" href="../../PostProcessing/gl/">GL</a></li><li><a class="tocitem" href="../../PostProcessing/xtool/">xtool</a></li><li><a class="tocitem" href="../../PostProcessing/PostPP/">PostPP</a></li><li><a class="tocitem" href="../../PostProcessing/Interpolation/">Interpolation GL</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-8" type="checkbox"/><label class="tocitem" for="menuitem-3-8"><span class="docs-label">Verification</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Verification/Extract4verification/">Extract4verification</a></li><li><a class="tocitem" href="../../Verification/Verification/">Verification</a></li><li><a class="tocitem" href="../../Verification/HARP/">HARP</a></li><li><a class="tocitem" href="../../Verification/Obsmon/">Obsmon</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-9" type="checkbox"/><label class="tocitem" for="menuitem-3-9"><span class="docs-label">Visualization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Visualization/EPyGrAM/">EpyGram</a></li></ul></li></ul></li><li><span class="tocitem">System</span><ul><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox" checked/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Build</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../General/">Software requirements</a></li><li><a class="tocitem" href="../Build_with_makeup/">Makeup</a></li><li><a class="tocitem" href="../gmkpack/">Gmkpack</a></li><li><a class="tocitem" href="../Gmkpack_vs_Make/">Gmkpack vs Make</a></li><li class="is-active"><a class="tocitem" href>Compile Harmonie</a><ul class="internal"><li><a class="tocitem" href="#Build-HARMONIE-from-the-HARMONIE-repository"><span>Build HARMONIE from the HARMONIE repository</span></a></li><li><a class="tocitem" href="#Install-namelists"><span>Install namelists</span></a></li><li><a class="tocitem" href="#Climate-Files"><span>Climate Files</span></a></li><li><a class="tocitem" href="#Prepare-the-input-data"><span>Prepare the input data</span></a></li><li><a class="tocitem" href="#Get-the-binaries-in-place"><span>Get the binaries in place</span></a></li><li><a class="tocitem" href="#Running-the-created-AROME"><span>Running the created AROME</span></a></li></ul></li><li><a class="tocitem" href="../Installation/">Installation</a></li><li><a class="tocitem" href="../Redhat7Install/">Redhat7 Install</a></li><li><a class="tocitem" href="../Centos6Install/">Centos6 Install</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Phasing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../System/MFaccess/">MF Access</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Suite Management</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../SuiteManagement/ECFLOW/">ECFLOW</a></li></ul></li><li><a class="tocitem" href="../../System/HarmonieTestbed/">Testbed</a></li><li><a class="tocitem" href="../../System/ECMWF_teleport/">Teleport</a></li><li><a class="tocitem" href="../../System/DrHook/">DrHook</a></li><li><a class="tocitem" href="../../System/StandaloneOdb/">Stand alone ODB</a></li><li><a class="tocitem" href="../../System/UpdateNamelists/">Update Namelist</a></li><li><a class="tocitem" href="../../System/Scalability_and_Refactoring/">Scalability and refactoring</a></li><li><a class="tocitem" href="../../System/HarmonieBenchMark/">Benchmark</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">System</a></li><li><a class="is-disabled">Build</a></li><li class="is-active"><a href>Compile Harmonie</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Compile Harmonie</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Hirlam/Harmonie/blob/pre-CY46h1/docs/src/Build/CompileHarmonie.md" title="Edit on GitHub"><span class="docs-icon fab">ï</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Install-Harmonie-31h1-on-an-independent-platform"><a class="docs-heading-anchor" href="#Install-Harmonie-31h1-on-an-independent-platform">Install Harmonie 31h1 on an independent platform</a><a id="Install-Harmonie-31h1-on-an-independent-platform-1"></a><a class="docs-heading-anchor-permalink" href="#Install-Harmonie-31h1-on-an-independent-platform" title="Permalink"></a></h1><h2 id="Build-HARMONIE-from-the-HARMONIE-repository"><a class="docs-heading-anchor" href="#Build-HARMONIE-from-the-HARMONIE-repository">Build HARMONIE from the HARMONIE repository</a><a id="Build-HARMONIE-from-the-HARMONIE-repository-1"></a><a class="docs-heading-anchor-permalink" href="#Build-HARMONIE-from-the-HARMONIE-repository" title="Permalink"></a></h2><p>The following assumes you have a working GNU/Linux system with gfortran and gcc (version &gt;= 4.3.0) in your PATH. You can obtain <a href="http://gcc.gnu.org/wiki/GFortranBinaries">binaries here</a>. Note also that the description below is valid for HARMONIE system around cycle 31h1. Please consult relevant updates in [wiki:HarmonieSystemDocumentation HARMONIE documentation for later cycles]</p><h3 id="Preparation"><a class="docs-heading-anchor" href="#Preparation">Preparation</a><a id="Preparation-1"></a><a class="docs-heading-anchor-permalink" href="#Preparation" title="Permalink"></a></h3><p>First you need some auxiliary libraries (attached to this page), provided by ECMWF and Meteo France. Create a directory <code>$HOME/auxlibs</code> and put the following files there:</p><pre><code class="language-bash hljs">-rw-r--r--  1 harmonie harmonie   873979 2007-05-28 11:39 auxlibs_ecmwf.0.2.tgz            ECMWF&#39;s sources
-rw-r--r--  1 harmonie harmonie   156049 2007-05-28 11:40 auxlibs_meteo-france.0.2.tgz     Meteo France&#39;s sources</code></pre><p>Note that <code>auxlibs_ecmwf.0.2/bufrdc_000240/bufrdc/buevar.F</code> contains a superfluous <code>EXTERNAL GETENV</code>.  Surround this by <code>#ifndef linux</code> and <code>#endif</code> before make-ing.</p><p>Unpack both gzipped tar files.  Until we fix this in the online copy, in<code>auxlibs_ecmwf.0.2/</code>, add the flag <code>-DINTEGER_IS_INT</code> to each <code>CFLAGS</code>, <code>FASTCFLAGS</code> variable in the various <code>config.linux*_gnu*</code> files.</p><p>In each of the <code>auxlibs_ecmwf.0.2</code> / <code>auxlibs_meteo_france.0.2</code> directory, build the libraries by running the script</p><pre><code class="language-bash hljs">        ./make_everything</code></pre><p>If your GNU/Linux system doesn&#39;t have the libraries BLAS and LAPACK installed (see <code>ls -l /usr/lib/blas /usr/lib/lapack</code>), get them from http://netlib.org and build them.  Install them as <code>libblas.a</code> and <code>liblapack.a</code> in <code>$HOME/auxlibs</code>.</p><h3 id="Get-the-source-and-build"><a class="docs-heading-anchor" href="#Get-the-source-and-build">Get the source and build</a><a id="Get-the-source-and-build-1"></a><a class="docs-heading-anchor-permalink" href="#Get-the-source-and-build" title="Permalink"></a></h3><p>Now check out HARMONIE from the repository at the host hirlam.org:</p><pre><code class="language-bash hljs">        svn export https://svn.hirlam.org/trunk/harmonie                              # for the latest trunk version
        svn export https://svn.hirlam.org/tags/harmonie-31h1 harmonie                 # for the tagged version 31h1
        svn export https://svn.hirlam.org/branches/harmonie-31h1 harmonie             # for the stable branch 31h1</code></pre><p>[ If you can&#39;t reach hirlam.org from the machine you want to build HARMONIE on, you&#39;ll have to do this on another machine and tar the result and copy it to the build machine]</p><p>Get the GMKPACK utilities from the HARMONIE source code repository, i.e., in <code>$HOME</code>, perform the following:</p><pre><code class="language-bash hljs">        cp -R &lt;harmonie-repository-root&gt;/harmonie/util/gmkpack .</code></pre><p>Export the following environment variables or add them to <code>~/.bash_profile</code>:</p><pre><code class="language-bash hljs">        export GMKROOT=$HOME/gmkpack
        export ROOTPACK=$HOME/HARMONIE
        export HOMEPACK=$ROOTPACK
        export HOMEBIN=$HOMEPACK
        export GMKFILE=GFORTRAN.LINUX
        export GMKTMP=/tmp
        export PATH=$GMKROOT/util:$PATH
        export MANPATH=$MANPATH:$GMKROOT/man</code></pre><p>Then run build_gmkpack in directory gmkpack.</p><p>Create the directory for the new pack:</p><pre><code class="language-bash hljs">        mkdir $ROOTPACK</code></pre><p>Then run gmkpack in that directory:</p><pre><code class="language-bash hljs">        cd $ROOTPACK
        gmkpack -r 31h1 -a -p arome                  # 31h1 here refers to the source code cycle number </code></pre><p>This creates the subdirectory <code>31h1_main.01.420</code>.</p><p>Go to directory <code>31h1_main.01.420./src/local</code> and copy the HARMONIE sources to it.</p><pre><code class="language-bash hljs">        cp -R &lt;harmonie-repository-root&gt;/harmonie/src/. .</code></pre><p>Then run the compile script from the <code>31h1_main.01.420</code>. directory:</p><pre><code class="language-bash hljs">        ./ics_arome</code></pre><p>If the version of flex installed on your system is newer than 2.5.4, the build will abort because of a bug in flex.</p><p>Go to directory <code>sys/odb98</code> and change <code>lex.yy.c</code> so that the defines</p><pre><code class="language-bash hljs">        #define INITIAL 0
        #define LEX_NORMAL 1
        #define LEX_INCLUDE 2
        #define LEX_SET 3
        #define LEX_TYPE 4
        #define LEX_TABLE 5
        #define LEX_VIEW 6
        #define LEX_FROM 7
        #define LEX_ORDERBY 8
        #define LEX_EXCLUDED_BY_IFDEF 9</code></pre><p>precede their uses.</p><p>Re-compile the <code>lex.yy.c</code> file:</p><pre><code class="language-bash hljs">        gcc -g -c -I. -I../../src/local/odb/compiler lex.yy.c</code></pre><p>This is a bug, confirmed by the flex maintainers (http://flex.sourceforge.net).</p><p>There are two violations of the Fortran Standard in the sources:</p><pre><code class="nohighlight hljs">        src/local/mpa/micro/internals/ini_rain_ice.mnh</code></pre><p>and</p><pre><code class="nohighlight hljs">        src/local/mpa/micro/internals/budget.mnh</code></pre><p>in both cases, comment out the declaration of integer variable <code>ILUOUT0</code>.</p><p>Recompile by by running the compile script from the <code>31h1_main.01.420</code>. directory:</p><pre><code class="language-bash hljs">        ./ics_arome</code></pre><p>This completes the build of the main 31h1 cycle.</p><h3 id="Derived-pack-and-make-local-changes"><a class="docs-heading-anchor" href="#Derived-pack-and-make-local-changes">Derived pack and make local changes</a><a id="Derived-pack-and-make-local-changes-1"></a><a class="docs-heading-anchor-permalink" href="#Derived-pack-and-make-local-changes" title="Permalink"></a></h3><p>Now create a derived pack so that you can add local updates:</p><p>Start by creating a separate directory in your home directory (here chosen to be <code>ARO</code>):</p><pre><code class="language-bash hljs">         mkdir AROME
         cd AROME</code></pre><p>Then, reflect this derived pack in your exported environment variables:</p><pre><code class="language-bash hljs">         export HOMEPACK=$HOME/AROME
         export HOMEBIN=$HOMEPACK</code></pre><p>Enter the <code>HOMEPACK</code> directory:</p><pre><code class="language-bash hljs">         cd $HOMEPACK</code></pre><p>and create the derived pack (identified by the string <code>EXP</code>):</p><pre><code class="language-bash hljs">         gmkpack -r 31h1 -u EXP -p arome</code></pre><p>Go to this derived pack&#39;s directory:</p><pre><code class="language-bash hljs">         cd $HOMEPACK/EXP</code></pre><p>and copy the HARMONIE scripts:</p><pre><code class="language-bash hljs">         cp -R &lt;harmonie-repository-root&gt;/harmonie/scr .</code></pre><h3 id="Additional-local-changes-for-cycle-31h1"><a class="docs-heading-anchor" href="#Additional-local-changes-for-cycle-31h1">Additional local changes for cycle 31h1</a><a id="Additional-local-changes-for-cycle-31h1-1"></a><a class="docs-heading-anchor-permalink" href="#Additional-local-changes-for-cycle-31h1" title="Permalink"></a></h3><p>For code in cycle 31h1, we have to update a few source files because they lead to Segmentation Violations (two because of errors in the source code, one because of a compiler error):</p><pre><code class="language-bash hljs">          cp ~/HARMONIE/31h1_main.01.420./src/local/arp/utility/echien.F90 ./src/local/arp/utility/
          cp ~/HARMONIE/31h1_main.01.420./src/local/arp/pp_obs/openfpfa.F90 ./src/local/arp/pp_obs/</code></pre><p>In those files, add a logical variable <code>LDGARDS</code>, set it to <code>.FALSE.</code> and change the last argument to subroutine <code>FACIES</code> to <code>LDGARDS</code>.</p><p>The following is filed as a <a href="http://gcc.gnu.org/PR33298">bug report</a>. As the report indicates, this has been fixed as of 2007/09/06.  If your compiler is of this date or later (see gfortran -v), you don&#39;t have to perform this update:</p><p>In the following file:</p><pre><code class="language-bash hljs">          cp ~/HARMONIE/31h1_main.01.420./src/local/mse/internals/soil_albedo_1d_patch.mnh ./src/local/mse/internals/</code></pre><p>change the following lines:</p><pre><code class="language-bash hljs">CASE (&#39;DRY &#39;)
  PALBVIS_SOIL(:,:) = SPREAD(PALBVIS_DRY(:),2,IPATCH)
  PALBNIR_SOIL(:,:) = SPREAD(PALBNIR_DRY(:),2,IPATCH)
  PALBUV_SOIL (:,:) = SPREAD(PALBUV_DRY (:),2,IPATCH)</code></pre><p>into:</p><pre><code class="language-bash hljs">CASE (&#39;DRY &#39;)
  DO JPATCH = 1, IPATCH
     PALBVIS_SOIL(:,JPATCH) = PALBVIS_DRY(:)
     PALBNIR_SOIL(:,JPATCH) = PALBNIR_DRY(:)
     PALBUV_SOIL (:,JPATCH) = PALBUV_DRY (:)
  ENDDO</code></pre><p>Filed as a <a href="http://gcc.gnu.org/PR33298">bug report</a>. As the report indicates, this has been fixed as of 2007/09/06.</p><p>Go back to the derived pack&#39;s directory and build the derived AROME executable.</p><pre><code class="language-bash hljs">          ./ics_arome</code></pre><p>You will see the three updated routines being recompiled and added to their respective libraries.</p><h3 id="Prepare-scripts"><a class="docs-heading-anchor" href="#Prepare-scripts">Prepare scripts</a><a id="Prepare-scripts-1"></a><a class="docs-heading-anchor-permalink" href="#Prepare-scripts" title="Permalink"></a></h3><p>Now change two scripts you definitely have to change (<code>Env_expdesc</code>, because it describes your experiment and Climate and ExtractBD, because the original scripts assumes the original (non-interpolated) climate data and boundary files reside on ECFS at ECMWF [change ecp to cp]):</p><p>This assumes you have accumulated all HARMONIE climate data residing at <code>ec:/rmt/clim_database</code> in a equal tree of plain files.</p><pre><code class="language-bash hljs">          cd scr
          edit Env_expdesc Climate ExtractBD</code></pre><p>In <code>Env_expdesc</code>, at least change the following:</p><pre><code class="language-bash hljs">TSTEP=60                                # Time step
MODEL=AROME                             # Forecast model to execute
                                        # ALADIN,AROME,ALDODB,AROMODB

FLAG=&quot;arome&quot;                            # Model/NH flag for finding right namelist etc
HOST_MODEL=&quot;hir&quot;                        # Host model, could be hir,ifs,ald
TRGT_MODEL=&quot;aro&quot;                        # Target model, could be ald,aro</code></pre><p>and set the domain of your choice.</p><p>Now unpack your climate data so that it resides under the directory indicated in <code>Env_expdesc</code> (environment variable <code>CLIMDATA</code>) (we can actually not use it yet, because some steps in the climate file generation currently have to be executed at ECMWF).</p><h3 id="Build-additional-utilities"><a class="docs-heading-anchor" href="#Build-additional-utilities">Build additional utilities</a><a id="Build-additional-utilities-1"></a><a class="docs-heading-anchor-permalink" href="#Build-additional-utilities" title="Permalink"></a></h3><p>Prepare the source for the HARMONIE conversion utilities:</p><pre><code class="language-bash hljs">          mkdir util
          cd util
          cp -R &lt;harmonie-repository-root&gt;/harmonie/util/gl  .</code></pre><p>and build them:</p><pre><code class="language-bash hljs">          cd ../util/gl</code></pre><p>Change the ARCH variable in the Makefile to linuxgfortran.</p><p>Then repair this error:</p><pre><code class="language-bash hljs">.../prg/gl.F90:75: undefined reference to `iargc_&#39;
.../prg/gl.F90:84: undefined reference to `getarg_&#39;</code></pre><p>iargc and getarg are <em>not</em> external functions, they are (non-standard) intrinsics (remove their declarations).</p><p>And this one</p><pre><code class="language-bash hljs">.../prg/dumpfld.f90:52/3/4: Error: Nonnegative width required in format string at (1)</code></pre><p>by changing the format specification to <code>fmt=*</code>.</p><p>Then issue the make command:</p><pre><code class="language-bash hljs">          make</code></pre><p>[ You can clean up if something goes wrong by typing &quot;make clean&quot;.]</p><h2 id="Install-namelists"><a class="docs-heading-anchor" href="#Install-namelists">Install namelists</a><a id="Install-namelists-1"></a><a class="docs-heading-anchor-permalink" href="#Install-namelists" title="Permalink"></a></h2><p>Subsequently, we copy the namelists from the HARMONIE repository to HOMEPACK:</p><pre><code class="language-bash hljs">          cp -R &lt;harmonie-repository-root&gt;/harmonie/nam .</code></pre><p>Now, unfortunately, the run scripts assume that the experiment name (environment variable MYLIB) is test_31h1.  Therefore, in the HOMEPACK directory we make a soft link:</p><pre><code class="language-bash hljs">          ln -s EXP test_31h1</code></pre><p>This is also the reason why you have to make soft links for all namelists in the nam directory with &quot;31t1&quot; in it to use &quot;31h1&quot;, e.g.</p><pre><code class="language-bash hljs">          ln -s namelist_31t1_ald2ald_nh_default namelist_31h1_ald2ald_nh_default
          ...</code></pre><p>and change <code>LMPOFF</code> to <code>.TRUE.</code> in <code>namelist_31h1_fcstarome_default</code> [don&#39;t you love negative logic].</p><h2 id="Climate-Files"><a class="docs-heading-anchor" href="#Climate-Files">Climate Files</a><a id="Climate-Files-1"></a><a class="docs-heading-anchor-permalink" href="#Climate-Files" title="Permalink"></a></h2><p>Now create the climate files for the intermediate and final model domain on ECMWF.  A good choice for the intermediate grid is to use the same center as the high resolution grid and a resolution 4 times as coarse and with 1/3rd the number of grid points in the X and Y directory.  In this way you will be sure that the high resolution domain is completely contained in the intermediate one.  Of course you also have to ensure that the intermediate grid is completely contained inside the HIRLAM domain you derive the boundaries from.</p><h2 id="Prepare-the-input-data"><a class="docs-heading-anchor" href="#Prepare-the-input-data">Prepare the input data</a><a id="Prepare-the-input-data-1"></a><a class="docs-heading-anchor-permalink" href="#Prepare-the-input-data" title="Permalink"></a></h2><p>First, make a scratch directory, for instance in the <code>$HOME</code> directory, and let the environment variable <code>$TEMP</code> point to it:</p><pre><code class="language-bash hljs">          mkdir $HOME/scratch
          export TEMP=$HOME/scratch</code></pre><p>Make a directory for the intermediate climate files and copy them there:</p><pre><code class="language-bash hljs">          mkdir -p $TEMP/HARMONIE/RCRa/climate
          for m in 01 02 03 04 05 06 07 08 09 10 11 12
          do
             cp &lt;intermediate-climate-dir&gt;/m$m $TEMP/HARMONIE/RCRa/climate
          done</code></pre><p>Make a directory for the high resolution climate files and copy them there:</p><pre><code class="language-bash hljs">          mkdir -p $TEMP/HARMONIE/test_31h1/climate
          for m in 01 02 03 04 05 06 07 08 09 10 11 12
          do
             cp &lt;highres-climate-dir&gt;/m$m $TEMP/HARMONIE/test_31h1/climate
          done
          cp &lt;highres-climate-dir&gt;/PGD.lfi $TEMP/HARMONIE/test_31h1/climate</code></pre><p>Make a directory for the HIRLAM history files to use as boundaries for your HARMONIE run:</p><pre><code class="language-bash hljs">          mkdir -p $TEMP/HARMONIE/RCRa/archive
          for fp in 000 003 006 009 012 015 018 021 024
          do
             cp fcYYYYMMDD_HH+$fp $TEMP/HARMONIE/RCRa/archive
          done</code></pre><p>[ Note that this assumes that you have changed ExtractBD (<code>$HOST_MODEL=hir</code>) to copy them from there, instead of ecp -o them from ECFS:</p><pre><code class="language-bash hljs">          ...
          cp $TEMP/HARMONIE/RCRa/archive/$FILE .
          ...</code></pre><p>]</p><h2 id="Get-the-binaries-in-place"><a class="docs-heading-anchor" href="#Get-the-binaries-in-place">Get the binaries in place</a><a id="Get-the-binaries-in-place-1"></a><a class="docs-heading-anchor-permalink" href="#Get-the-binaries-in-place" title="Permalink"></a></h2><p>Go to <code>$HOMEPACK/EXP/scr</code>.</p><p>Copy the AROME binary to the scratch tree:</p><pre><code class="language-bash hljs">          mkdir -p $TEMP/HARMONIE/test_31h1/bin
          cp ../bin/AROME $TEMP/HARMONIE/test_31h1/bin</code></pre><p>Also copy the gl utilities over there:</p><pre><code class="language-bash hljs">          cp ../util/gl/bin/* $TEMP/HARMONIE/test_31h1/bin</code></pre><p>Finally, steal a mandtg from a HIRLAM repository you have lying around:</p><pre><code class="language-bash hljs">          cp &lt;HIRLAM-repository&gt;/scripts/mandtg $TEMP/HARMONIE/test_31h1/bin</code></pre><h2 id="Running-the-created-AROME"><a class="docs-heading-anchor" href="#Running-the-created-AROME">Running the created AROME</a><a id="Running-the-created-AROME-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-created-AROME" title="Permalink"></a></h2><p>Set the start and end date for which you have input data in the script <code>Start_harmonie</code> and run it:</p><pre><code class="language-bash hljs">          ./Start_harmonie</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Gmkpack_vs_Make/">Â« Gmkpack vs Make</a><a class="docs-footer-nextpage" href="../Installation/">Installation Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.15 on <span class="colophon-date" title="Friday 18 March 2022 15:59">Friday 18 March 2022</span>. Using Julia version 1.6.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
