<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>System · Harmonie wiki</title><meta name="title" content="System · Harmonie wiki"/><meta property="og:title" content="System · Harmonie wiki"/><meta property="twitter:title" content="System · Harmonie wiki"/><meta name="description" content="Documentation for Harmonie wiki."/><meta property="og:description" content="Documentation for Harmonie wiki."/><meta property="twitter:description" content="Documentation for Harmonie wiki."/><meta property="og:url" content="https://hirlam.github.io/HarmonieSystemDocumentation/dev/EPS/System/"/><meta property="twitter:url" content="https://hirlam.github.io/HarmonieSystemDocumentation/dev/EPS/System/"/><link rel="canonical" href="https://hirlam.github.io/HarmonieSystemDocumentation/dev/EPS/System/"/><script async src="https://www.googletagmanager.com/gtag/js?id=G-HQ1BCP3LPJ"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HQ1BCP3LPJ', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Harmonie wiki logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Harmonie wiki</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../System/GitDeveloperDocumentation/">GitHub workflow</a></li><li><a class="tocitem" href="../../Overview/da_graph/">Graphical Overview</a></li><li><a class="tocitem" href="../../System/ECMWF/RunningHarmonieOnAtos/">Running on Atos</a></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Overview</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Overview/Content/">Content</a></li><li><a class="tocitem" href="../../Overview/Binaries/">Binaries</a></li><li><a class="tocitem" href="../../Overview/FileFormats/">File Formats</a></li><li><a class="tocitem" href="../../Overview/Source/">Source</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-5" type="checkbox"/><label class="tocitem" for="menuitem-2-5"><span class="docs-label">Experiment Configuration</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ExperimentConfiguration/ConfigureYourExperiment/">Experiment</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/Namelists/">Namelist</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/UseofObservation/">Observations</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/PlatformConfiguration/">Platform</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/How_to_use_hires_topography/">HiRes Topography</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/ModelDomain/">Domain</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/VerticalGrid/">Vertical Grid</a></li></ul></li></ul></li><li><span class="tocitem">NWP Components</span><ul><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Observations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1-1"><span class="docs-label">Preprocessing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Observations/ObservationPreprocessing/">Preprocessing</a></li><li><a class="tocitem" href="../../Observations/Oulan/">Oulan</a></li><li><a class="tocitem" href="../../Observations/Bator/">Bator</a></li><li><a class="tocitem" href="../../Observations/Cope/">Cope</a></li><li><a class="tocitem" href="../../Observations/ObservationData/">ObservationData</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-1-2" type="checkbox"/><label class="tocitem" for="menuitem-3-1-2"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Observations/SYNOP/">SYNOP</a></li><li><a class="tocitem" href="../../Observations/Amv/">AMV</a></li><li><a class="tocitem" href="../../Observations/Atovs/">ATOVS</a></li><li><a class="tocitem" href="../../Observations/Iasi/">IASI</a></li><li><a class="tocitem" href="../../Observations/Seviri/">SEVIRI</a></li><li><a class="tocitem" href="../../Observations/Scatt/">Scatt</a></li><li><a class="tocitem" href="../../Observations/Ascat/">AScat</a></li><li><a class="tocitem" href="../../Observations/GNSS/">GNSS</a></li><li><a class="tocitem" href="../../Observations/Modes/">Modes</a></li><li><a class="tocitem" href="../../Observations/RadarData/">Radar</a></li><li><a class="tocitem" href="../../Observations/Aeolus/">Aeolus</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Data Assimilation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-2-1" type="checkbox"/><label class="tocitem" for="menuitem-3-2-1"><span class="docs-label">Surface</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI/">CANARI</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI_OI_MAIN/">CANARI OI MAIN</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI_EKF_SURFEX/">CANARI EKF SURFEX</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/SurfaceAnalysis/">Surface Analysis</a></li></ul></li><li><a class="tocitem" href="../../DataAssimilation/Screening/">Screening</a></li><li><a class="tocitem" href="../../DataAssimilation/StructureFunctions/">Structure functions</a></li><li><a class="tocitem" href="../../DataAssimilation/DaAlgorithms/">Algorithms</a></li><li><a class="tocitem" href="../../DataAssimilation/DigitalFilterInitialization/">Digital Filter Initialization</a></li><li><a class="tocitem" href="../../DataAssimilation/ObservationOperators/">HOP_DRIVER</a></li><li><a class="tocitem" href="../../DataAssimilation/SingleObs/">Single Obs</a></li><li><a class="tocitem" href="../../DataAssimilation/LSMIXandJk/">LSMIX and Jk</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-3-1"><span class="docs-label">Data Assimilation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DataAssimilation/DFS/">DFS</a></li><li><a class="tocitem" href="../../DataAssimilation/MTEN/">MTEN</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-3-2"><span class="docs-label">Forecast(spin-up)</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DataAssimilation/CHKEVO/">CHKEVO</a></li><li><a class="tocitem" href="../../DataAssimilation/NWECHKEVO/">NWECHKEVO</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Boundaries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Boundaries/BoundaryFilePreparation/">Preparation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Forecast Model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ForecastModel/Forecast/">Forecast</a></li><li><a class="tocitem" href="../../ForecastModel/ForecastSettings/">Settings</a></li><li><a class="tocitem" href="../../ForecastModel/Outputlist/">Output List</a></li><li><a class="tocitem" href="../../ForecastModel/HR/">High Res</a></li><li><input class="collapse-toggle" id="menuitem-3-5-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5-5"><span class="docs-label">Single Column Model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC/">MUSC</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/Forcing/">Forcing</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC_EMS/">MUSC EMS</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC_vars/">MUSC vars</a></li></ul></li><li><a class="tocitem" href="../../ForecastModel/WindFarms/">Wind Farm Parameterisation</a></li><li><a class="tocitem" href="../../ForecastModel/DDH/">Use of DDH</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">Climate Generation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ClimateGeneration/ClimateGeneration/">Climate Generation</a></li><li><a class="tocitem" href="../../ClimateGeneration/DownloadInputData/">Input Data</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-7" type="checkbox" checked/><label class="tocitem" for="menuitem-3-7"><span class="docs-label">EPS</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../Howto/">Howto</a></li><li class="is-active"><a class="tocitem" href>System</a><ul class="internal"><li><a class="tocitem" href="#Overview"><span>Overview</span></a></li><li><a class="tocitem" href="#Purpose"><span>Purpose</span></a></li><li><a class="tocitem" href="#Prerequisites"><span>Prerequisites</span></a></li><li><a class="tocitem" href="#Option-checking"><span>Option checking</span></a></li><li><a class="tocitem" href="#EPS-in-the-tdf-file"><span>EPS in the tdf file</span></a></li><li><a class="tocitem" href="#Make-member-specific-namelist-changes"><span>Make member specific namelist changes</span></a></li></ul></li><li><a class="tocitem" href="../BDSTRATEGY/">BDSTRATEGY</a></li><li><a class="tocitem" href="../SLAF/">SLAF</a></li><li><a class="tocitem" href="../SPP/">SPP</a></li><li><a class="tocitem" href="../SPPT/">SPPT</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-8" type="checkbox"/><label class="tocitem" for="menuitem-3-8"><span class="docs-label">Post Processing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../PostProcessing/Diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../../PostProcessing/FileConversions/">FileConversions</a></li><li><a class="tocitem" href="../../PostProcessing/Fullpos/">FullPos</a></li><li><a class="tocitem" href="../../PostProcessing/gl/">GL</a></li><li><a class="tocitem" href="../../PostProcessing/xtool/">xtool</a></li><li><a class="tocitem" href="../../PostProcessing/Interpolation/">Interpolation GL</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-9" type="checkbox"/><label class="tocitem" for="menuitem-3-9"><span class="docs-label">Verification</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Verification/Extract4verification/">Extract4verification</a></li><li><a class="tocitem" href="../../Verification/Verification/">Verification</a></li><li><a class="tocitem" href="../../Verification/AllobsVerification/">allobs Verification</a></li><li><a class="tocitem" href="../../Verification/HARP/">HARP</a></li><li><a class="tocitem" href="../../Verification/Obsmon/">Obsmon</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-10" type="checkbox"/><label class="tocitem" for="menuitem-3-10"><span class="docs-label">Visualization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Visualization/EPyGrAM/">EpyGram</a></li></ul></li></ul></li><li><span class="tocitem">System</span><ul><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Build</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Build/Build_with_cmake/">CMake</a></li><li><a class="tocitem" href="../../Build/Build_with_makeup/">Makeup</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Phasing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../System/MFaccess/">MF Access</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Suite Management</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../SuiteManagement/ECFLOW/">ECFLOW</a></li></ul></li><li><a class="tocitem" href="../../System/TheHarmonieScript/">The Harmonie script</a></li><li><a class="tocitem" href="../../System/ECMWF/RunningHarmonieOnAtos/">Running on ECMWF&#39;s Atos</a></li><li><a class="tocitem" href="../../System/ReleaseProcess/">Harmonie release process</a></li><li><a class="tocitem" href="../../System/Local/QuickStartLocal/">Local</a></li><li><a class="tocitem" href="../../System/HarmonieTestbed/">Testbed</a></li><li><a class="tocitem" href="../../System/ECMWF/ECMWF_teleport/">Teleport</a></li><li><a class="tocitem" href="../../System/Build_local_docs/">Local Documentation</a></li><li><a class="tocitem" href="../../System/DrHook/">DrHook</a></li><li><a class="tocitem" href="../../System/StandaloneOdb/">Stand alone ODB</a></li><li><a class="tocitem" href="../../System/UpdateNamelists/">Update Namelist</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">NWP Components</a></li><li><a class="is-disabled">EPS</a></li><li class="is-active"><a href>System</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>System</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Hirlam/Harmonie" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Hirlam/Harmonie/blob/dev-CY46h1/docs/src/EPS/System.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="eps-system"><a class="docs-heading-anchor" href="#eps-system">Ensemble mode in the Harmonie script system</a><a id="eps-system-1"></a><a class="docs-heading-anchor-permalink" href="#eps-system" title="Permalink"></a></h1><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><ul><li>Purpose</li><li>Prerequisites</li><li>Option checking</li><li>EPS in the tdf file</li></ul><h2 id="Purpose"><a class="docs-heading-anchor" href="#Purpose">Purpose</a><a id="Purpose-1"></a><a class="docs-heading-anchor-permalink" href="#Purpose" title="Permalink"></a></h2><p>The purpose of this document is to give more details about how ensemble mode works in the Harmonie script system than can easily be found in other pages.  It is meant for system people and developers who need to understand or extend the functionality of HarmonEPS.  Such extensions could be e.g. implementation of new initial perturbation techniques.</p><h2 id="Prerequisites"><a class="docs-heading-anchor" href="#Prerequisites">Prerequisites</a><a id="Prerequisites-1"></a><a class="docs-heading-anchor-permalink" href="#Prerequisites" title="Permalink"></a></h2><p>You should also read the <a href="../Howto/#eps-howto">Howto</a> to get acquainted with what is already implemented.</p><p>Having read the prerequisite pages you know that an ensemble experiment is not very different from a deterministic one, you only need to set a few ensemble related variables <code>ENSMSEL</code>, <code>ENSINIPERT</code>, etc. in <code>ecf/config_exp.h</code> and then make some member specific exceptions in the perl &quot;module&quot; <code>msms/harmonie.pm</code>. But there is more going on behind the scenes.</p><p>First of all, the <code>ENSMSEL</code> member selection variable exists for convenience, what is used in <code>msms/harmonie.tdf</code> and other scripts is an <em>expanded</em> version of it called <code>ENSMSELX</code>. In the script <code>scr/Start</code> this expansion is done by invoking script <code>scr/Ens_util.pl</code>, which is also used to set a couple of other convenience variables:</p><pre><code class="language-bash hljs"># Compute derived EPS quantities, needed in harmonie.tdf
export ENSSIZE ENSMFIRST ENSMLAST
ENSSIZE=`perl -S Ens_util.pl ENSSIZE`
ENSMFIRST=`perl -S Ens_util.pl ENSMFIRST`
ENSMLAST=`perl -S Ens_util.pl ENSMLAST`
ENSCTL=`perl -S Ens_util.pl ENSCTL $ENSCTL`</code></pre><p>For example, if <code>ENSMSEL=0-8:2</code>, then <code>ENSMSELX=000:002:004:006:008</code>, i.e., a colon-separated list of 3-digit numbers.  In the same example, we will have <code>ENSMFIRST=000</code> and <code>ENSMLAST=008</code>. <code>ENSSIZE</code> will be 5.</p><h2 id="Option-checking"><a class="docs-heading-anchor" href="#Option-checking">Option checking</a><a id="Option-checking-1"></a><a class="docs-heading-anchor-permalink" href="#Option-checking" title="Permalink"></a></h2><p>As explained in the prerequisite documents, variables normally set in <code>ecf/config_exp.h</code>  can be overridden for specific ensemble members in <code>msms/harmonie.pm</code>. But how is it verified that the chosen combinations make sense for each member?</p><p>The main script that checks for a sensible combination of options in Harmonie is <code>scr/CheckOptions.pl</code>. This script runs already from the Start script before mini-SMS is launched in order to catch problems as early as possible. <code>CheckOptions.pl</code> reads <code>ecf/config_exp.h</code>  and creates a new file <code>sms/config_updated.h</code> (but under &quot;merged&quot; repository directory <code>$HM_LIB</code> rather than your experiment directory <code>$HM_WD</code>). In <code>config_updated.h</code> you will find some environment variables that are derived from others, e.g., a lot of domain specific variables (<code>NLON</code>,<code>NLAT</code>,<code>TSTEP</code> etc.) are derived from <code>$DOMAIN</code>. Every SMS task in the system includes first <code>config_exp.h</code> and then <code>config_updated.h</code>. At the very bottom of <code>config_updated.h</code> we find:</p><pre><code class="language-bash hljs">if [ ${ENSMBR--1} -ge 0]; then
  if [ -s $HM_LIB/sms/config_mbr$ENSMBR.h]; then
. $HM_LIB/sms/config_mbr$ENSMBR.h
  fi
fi</code></pre><p>That is, in ensemble mode, if <code>sms/config_mbr$ENSMBR.h</code> exists, it will also be sourced by every script. And finally, the way these member specific config files are created can be seen from this passage in the <code>Start</code> script:</p><pre><code class="language-bash hljs"># Check options for individual ensemble members if relevant
if [ $ENSSIZE -gt 0]; then
   perl -S CheckMemberOptions.pl || exit
fi</code></pre><p><code>scr/CheckMemberOptions.pl</code> includes the member specific <code>harmonie.pm</code> of course, and then it loops over all the selected members in turn, running <code>CheckOptions.pl</code> with the particular environment settings for the member in question. If a member (<code>$ENSMBR</code>) passes the tests, the file mentioned above, <code>$HM_LIB/sms/config_mbr$ENSMBR.h</code> is created. It will contain settings for those environment variables mentioned in harmonie.pm that differs from the default settings in <code>config_exp.h</code>. This makes the correct variables available to every script, without those scripts having to repeat the perl <code>&amp;Env</code> checking in <code>harmonie.pm</code>.</p><h2 id="EPS-in-the-tdf-file"><a class="docs-heading-anchor" href="#EPS-in-the-tdf-file">EPS in the tdf file</a><a id="EPS-in-the-tdf-file-1"></a><a class="docs-heading-anchor-permalink" href="#EPS-in-the-tdf-file" title="Permalink"></a></h2><p>In <code>harmonie.tdf</code> we have many loop constructs like the following example from the <code>MakeCycleInput</code> family:</p><pre><code class="language-bash hljs">      family Cycle
         task Prepare_cycle
loop(EEE,$ENV{ENSMFIRST},$ENV{ENSMLAST})
  if( $ENV{ENSMSELX} =~ /@EEE@\b/ and &#39;@EEE@&#39; ne &#39;-1&#39; )
         family Mbr@EEE@
            trigger ( Prepare_cycle == complete )
            complete ( (../../Hour:HH + 24 - $ENV{BeginHour}) % &amp;Env(&#39;FCINT&#39;,&#39;@EEE@&#39;) )
            edit ENSMBR @EEE@
            task Prepare_cycle
         endfamily
  endif
endloop
...</code></pre><p>As can be seen, all the loops over ensemble members go from the smallest number found in <code>ENSMSEL</code> (<code>ENSMFIRST</code>) to the highest number found (<code>ENSMLAST</code>), with steps of 1, but only if the actual number (<code>@EEE@</code>) is present in the expanded list <code>ENSMSELX</code> is anything put to harmonie.def for this potential member. The perl operator <code>=~</code> is the pattern match operator and <code>\b</code> means a word boundary (<code>:</code> or end of string in our case).</p><p>Note also how every member has its own family Mbr@EEE@ (which will expand to Mbr000, Mbr002, etc. in the <code>harmonie.def</code> file).  Another important thing to note is the setting</p><pre><code class="language-bash hljs">edit ENSMBR @EEE@</code></pre><p>This will first create an SMS variable <code>%ENSMBR%*</code> with different values for each member, which is also turned into a shell variable <code>$ENSMBR</code> in <code>sms/sms.h</code>, which is included by all SMS tasks. From <code>sms.h</code>:</p><pre><code class="language-bash hljs">ENSMBR=%ENSMBR%
if [ ${ENSMBR--1} -ge 0]; then
  ENSMBR=`echo %ENSMBR% | awk &#39;{printf &quot;%%3.3d&quot;,$1}&#39;`
  CYCLEDIR=%YMD%_${HH}/mbr$ENSMBR
fi
export ENSMBR</code></pre><p>The end message of this is that to get ensemble member number in a script you should use <code>$ENSMBR</code>.  In non-ensemble runs <code>ENSMBR</code> will have the value -1.</p><p>The statement</p><pre><code class="language-bash hljs">complete ( (../../Hour:HH + 24 - $ENV{BeginHour}) % &amp;Env(&#39;FCINT&#39;,&#39;@EEE@&#39;) )</code></pre><p>deserves more explanation. It is present to account for the fact that not all members need to have the same &quot;forecast interval&quot; <code>FCINT</code>. The Hour families in the tdf now look like this:</p><pre><code class="language-bash hljs">      family Hour
         repeat integer HH &amp;Env(&#39;FirstHour&#39;,&#39;min&#39;) 23 &amp;Env(&#39;FCINT&#39;,&#39;min&#39;)</code></pre><p>i.e., the loop steps with the minimum <code>FCINT</code> value found among the members.  Thus, if e.g. some members have <code>FCINT=6</code> and some <code>FCINT=12</code>, then the statement above sets the family immediately complete for members with <code>FCINT=12</code> at those cycles that are not divisible by 12 relative to the first cycle (BeginHour). I.e., if the run was started at a 06 or 18 cycle, members with <code>FCINT=12</code> will be complete (not run) at 00 and 12 cycles, but if the run was started at a 00 or 12 cycle, then members with <code>FCINT=12</code> will not run at 06 and 18 cycles.  This behaviour has confused many users and should perhaps be changed.</p><h2 id="Make-member-specific-namelist-changes"><a class="docs-heading-anchor" href="#Make-member-specific-namelist-changes">Make member specific namelist changes</a><a id="Make-member-specific-namelist-changes-1"></a><a class="docs-heading-anchor-permalink" href="#Make-member-specific-namelist-changes" title="Permalink"></a></h2><p>In Harmonie most namelists are created on the fly from the namelist <a href="../../ExperimentConfiguration/Namelists/#namelists">dictionary</a>. This allows us to make member specific changes to the namelists used in e.g. the forecast. In the following we will describe two ways of doing this.  </p><h3 id="Through-harmonie.pm"><a class="docs-heading-anchor" href="#Through-harmonie.pm">Through <code>harmonie.pm</code></a><a id="Through-harmonie.pm-1"></a><a class="docs-heading-anchor-permalink" href="#Through-harmonie.pm" title="Permalink"></a></h3><p>Assume we would like to change on parameter in the physcis. First we change the variable in the namelist to be dependent of an environment variable in <code>nam/harmonie_namelists.pm</code></p><pre><code class="language-perl hljs"> NAMPHY0=&gt;{
  &#39;ALMAV&#39; =&gt; &quot;$ENV{ALMAV}&quot;,
 ...
 },</code></pre><p>Second we make sure in <code>msms/harmonie.pm</code> that this environment variable is specified for each member, in this case four.</p><pre><code class="language-bash hljs">   &#39;ALMAV&#39;  =&gt; [ &#39;200.&#39;,&#39;100.&#39;,&#39;50.&#39;,&#39;300.&#39;],</code></pre><p>Finally we have to make sure that the variable is exported in <code>ecf/config_exp.h</code></p><pre><code class="language-bash hljs"> export ALMAV</code></pre><h3 id="Make-changes-to-the-namelist-generation"><a class="docs-heading-anchor" href="#Make-changes-to-the-namelist-generation">Make changes to the namelist generation</a><a id="Make-changes-to-the-namelist-generation-1"></a><a class="docs-heading-anchor-permalink" href="#Make-changes-to-the-namelist-generation" title="Permalink"></a></h3><p>Another way is to specify a set of namelist changes for each member in <code>nam/harmonie_namelists.pm</code>. We could simply add a definition for e.g. the first member like</p><pre><code class="language-perl hljs"> %member_001 = (
  NAERAD=&gt;{
   &#39;LRRTM&#39; =&gt; &#39;.FALSE.,&#39;,
  },
  NAMPHY0=&gt;{
   &#39;BEDIFV&#39; =&gt; &#39;0.05,&#39;,
  },
 ), </code></pre><p>To activate the change we also need to change <code>scr/Get_namelist</code>, the script that builds the namelist for us to take the <code>member_$ENSMBR</code> change into account.</p><pre><code class="language-bash hljs"> ...
 forecast|dfi|traj4d)
    NAMELIST_CONFIG=&quot;$DEFAULT dynamics $DYNAMICS $PHYSICS ${DYNAMICS}_${PHYSICS} $SURFACE $EXTRA_FORECAST_OPTIONS member_$ENSMBR&quot;
 ...</code></pre><p>Repeat this for all your members with the changes you would like to apply.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Howto/">« Howto</a><a class="docs-footer-nextpage" href="../BDSTRATEGY/">BDSTRATEGY »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Monday 7 October 2024 06:53">Monday 7 October 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
