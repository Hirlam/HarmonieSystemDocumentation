<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Structure functions · Harmonie wiki</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-221448594-1"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-221448594-1', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://hirlam.github.io/HarmonieSystemDocumentation/dev/DataAssimilation/StructureFunctions/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Harmonie wiki logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Harmonie wiki</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../System/GitDeveloperDocumentation/">GitHub workflow</a></li><li><a class="tocitem" href="../../Overview/da_graph/">Graphical Overview</a></li><li><a class="tocitem" href="../../System/ECMWF/RunningHarmonieOnAtos/">Running on Atos</a></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Overview</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Overview/Content/">Content</a></li><li><a class="tocitem" href="../../Overview/Binaries/">Binaries</a></li><li><a class="tocitem" href="../../Overview/FileFormats/">File Formats</a></li><li><a class="tocitem" href="../../Overview/Source/">Source</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-5" type="checkbox"/><label class="tocitem" for="menuitem-2-5"><span class="docs-label">Experiment Configuration</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ExperimentConfiguration/ConfigureYourExperiment/">Experiment</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/Namelists/">Namelist</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/UseofObservation/">Observations</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/PlatformConfiguration/">Platform</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/How_to_use_hires_topography/">HiRes Topography</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/ModelDomain/">Domain</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/VerticalGrid/">Vertical Grid</a></li></ul></li></ul></li><li><span class="tocitem">NWP Components</span><ul><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Observations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1-1"><span class="docs-label">Preprocessing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Observations/ObservationPreprocessing/">Preprocessing</a></li><li><a class="tocitem" href="../../Observations/Oulan/">Oulan</a></li><li><a class="tocitem" href="../../Observations/Bator/">Bator</a></li><li><a class="tocitem" href="../../Observations/Cope/">Cope</a></li><li><a class="tocitem" href="../../Observations/ObservationData/">ObservationData</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-1-2" type="checkbox"/><label class="tocitem" for="menuitem-3-1-2"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Observations/SYNOP/">SYNOP</a></li><li><a class="tocitem" href="../../Observations/Amv/">AMV</a></li><li><a class="tocitem" href="../../Observations/Iasi/">IASI</a></li><li><a class="tocitem" href="../../Observations/Atovs/">ATOVS</a></li><li><a class="tocitem" href="../../Observations/Scatt/">Scatt</a></li><li><a class="tocitem" href="../../Observations/Ascat/">AScat</a></li><li><a class="tocitem" href="../../Observations/GNSS/">GNSS</a></li><li><a class="tocitem" href="../../Observations/Modes/">Modes</a></li><li><a class="tocitem" href="../../Observations/RadarData/">Radar</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox" checked/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Data Assimilation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-2-1" type="checkbox"/><label class="tocitem" for="menuitem-3-2-1"><span class="docs-label">Surface</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../Surface/CANARI/">CANARI</a></li><li><a class="tocitem" href="../Surface/CANARI_OI_MAIN/">CANARI OI MAIN</a></li><li><a class="tocitem" href="../Surface/CANARI_EKF_SURFEX/">CANARI EKF SURFEX</a></li><li><a class="tocitem" href="../Surface/SurfaceAnalysis/">Surface Analysis</a></li></ul></li><li><a class="tocitem" href="../Screening/">Screening</a></li><li class="is-active"><a class="tocitem" href>Structure functions</a><ul class="internal"><li><a class="tocitem" href="#General"><span>General</span></a></li><li><a class="tocitem" href="#Generating-background-error-statistics-(using-43h2.2)"><span>Generating background error statistics (using 43h2.2)</span></a></li><li><a class="tocitem" href="#Diagnosis-of-background-error-statistics"><span>Diagnosis of background error statistics</span></a></li><li><a class="tocitem" href="#Run-3DVAR/4DVAR-with-the-new-background-error-statistics"><span>Run 3DVAR/4DVAR with the new background error statistics</span></a></li><li><a class="tocitem" href="#In-line-Interpolation-and-Extrapolation-of-Jb-statistics"><span>In-line Interpolation and Extrapolation of Jb-statistics</span></a></li><li><a class="tocitem" href="#On-going-work-and-future-developments"><span>On-going work &amp; future developments</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../DataAssimilation4DVAR/">4DVAR</a></li><li><a class="tocitem" href="../DigitalFilterInitialization/">Digital Filter Initialization</a></li><li><a class="tocitem" href="../ObservationOperators/">HOP_DRIVER</a></li><li><a class="tocitem" href="../SingleObs/">Single Obs</a></li><li><a class="tocitem" href="../LSMIXandJk/">LSMIX and Jk</a></li><li><a class="tocitem" href="../DFS/">DFS</a></li><li><a class="tocitem" href="../MTEN/">MTEN</a></li><li><a class="tocitem" href="../CHKEVO/">CHKEVO</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Boundaries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Boundaries/BoundaryFilePreparation/">Preparation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Forecast Model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ForecastModel/Forecast/">Forecast</a></li><li><a class="tocitem" href="../../ForecastModel/ForecastSettings/">Settings</a></li><li><a class="tocitem" href="../../ForecastModel/Outputlist/">Output List</a></li><li><a class="tocitem" href="../../ForecastModel/HR/">High Res</a></li><li><input class="collapse-toggle" id="menuitem-3-4-5" type="checkbox"/><label class="tocitem" for="menuitem-3-4-5"><span class="docs-label">Single Column Model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC/">MUSC</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/Forcing/">Forcing</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC_vars/">MUSC vars</a></li></ul></li><li><a class="tocitem" href="../../ForecastModel/WindFarms/">Wind Farm Parameterisation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Climate Generation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ClimateGeneration/ClimateGeneration/">Climate Generation</a></li><li><a class="tocitem" href="../../ClimateGeneration/DownloadInputData/">Input Data</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">EPS</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../EPS/Howto/">Howto</a></li><li><a class="tocitem" href="../../EPS/System/">System</a></li><li><a class="tocitem" href="../../EPS/BDSTRATEGY/">BDSTRATEGY</a></li><li><a class="tocitem" href="../../EPS/SLAF/">SLAF</a></li><li><a class="tocitem" href="../../EPS/SPP/">SPP</a></li><li><a class="tocitem" href="../../EPS/SPPT/">SPPT</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-7" type="checkbox"/><label class="tocitem" for="menuitem-3-7"><span class="docs-label">Post Processing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../PostProcessing/Diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../../PostProcessing/FileConversions/">FileConversions</a></li><li><a class="tocitem" href="../../PostProcessing/Fullpos/">FullPos</a></li><li><a class="tocitem" href="../../PostProcessing/gl/">GL</a></li><li><a class="tocitem" href="../../PostProcessing/xtool/">xtool</a></li><li><a class="tocitem" href="../../PostProcessing/PostPP/">PostPP</a></li><li><a class="tocitem" href="../../PostProcessing/Interpolation/">Interpolation GL</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-8" type="checkbox"/><label class="tocitem" for="menuitem-3-8"><span class="docs-label">Verification</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Verification/Extract4verification/">Extract4verification</a></li><li><a class="tocitem" href="../../Verification/Verification/">Verification</a></li><li><a class="tocitem" href="../../Verification/HARP/">HARP</a></li><li><a class="tocitem" href="../../Verification/Obsmon/">Obsmon</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-9" type="checkbox"/><label class="tocitem" for="menuitem-3-9"><span class="docs-label">Visualization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Visualization/EPyGrAM/">EpyGram</a></li></ul></li></ul></li><li><span class="tocitem">System</span><ul><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Build</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Build/Build_with_cmake/">CMake</a></li><li><a class="tocitem" href="../../Build/Build_with_makeup/">Makeup</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Phasing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../System/MFaccess/">MF Access</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Suite Management</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../SuiteManagement/ECFLOW/">ECFLOW</a></li></ul></li><li><a class="tocitem" href="../../System/TheHarmonieScript/">The Harmonie script</a></li><li><a class="tocitem" href="../../System/ECMWF/RunningHarmonieOnAtos/">Running on ECMWF&#39;s Atos</a></li><li><a class="tocitem" href="../../System/ReleaseProcess/">Harmonie release process</a></li><li><a class="tocitem" href="../../System/Local/QuickStartLocal/">Local</a></li><li><a class="tocitem" href="../../System/HarmonieTestbed/">Testbed</a></li><li><a class="tocitem" href="../../System/ECMWF/ECMWF_teleport/">Teleport</a></li><li><a class="tocitem" href="../../System/Build_local_docs/">Local Documentation</a></li><li><a class="tocitem" href="../../System/DrHook/">DrHook</a></li><li><a class="tocitem" href="../../System/StandaloneOdb/">Stand alone ODB</a></li><li><a class="tocitem" href="../../System/UpdateNamelists/">Update Namelist</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">NWP Components</a></li><li><a class="is-disabled">Data Assimilation</a></li><li class="is-active"><a href>Structure functions</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Structure functions</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Hirlam/Harmonie/blob/dev-CY46h1/docs/src/DataAssimilation/StructureFunctions.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Derivation-of-Structure-Functions"><a class="docs-heading-anchor" href="#Derivation-of-Structure-Functions">Derivation of Structure Functions</a><a id="Derivation-of-Structure-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Derivation-of-Structure-Functions" title="Permalink"></a></h1><h2 id="General"><a class="docs-heading-anchor" href="#General">General</a><a id="General-1"></a><a class="docs-heading-anchor-permalink" href="#General" title="Permalink"></a></h2><p>For each new model domain, in order to carry out upper air data assimilation (3DVAR or 4DVAR) one needs to generate background error covariances (generally referred to as structure functions).  The recommended procedure is to use a two step approach. In step one you generate background error statistics by downscaling (this is needed since you do not have have statistics for your domain setup for this forecast model version and physics options, so that you cannot run data-assimilation (unless you use statistics from old system possibly derived from a slighthly different domain and with a different model version, which is not recommended). In step 2 you then use the statistics derived in step 1 to generate the final background error statistics files by applying ensemble data assimilation within the HARMONIE-AROME modelling system.</p><p>In step 1 structure functions are generated from difference fields from ensemble members of HARMONIE-AROME forecast. These are obtained from downscaling of ECMWF EDA ensemble forecast. To alleviate spin-up issues, these phase 1 downscaled HARMONIE-AROME forecasts are run up to 6 hours, and differences are generated from these. Using the ECMWF LBC data, 6h HARMONIE ensemble forecasts are initiated from ECMWF 6h forecasts daily from 00 UTC and 12 UTC, with ECMWF forecasts as initial and lateral boundary conditions. To obtain stable statistics, it is recomended to run 4 ensembles for two chosen one-month episode (s). The episodes should sample different seasons.  Therefore it is recommended to run for one winter month and one summer month, for example June 2016 and January 2017. These periods are chosen so as to benefit from the latest upgrade to ECMWF&#39;s EDA system. Thereby we sample both seasonal (January, July)  and daily (00 UTC and 12 UTC) variations. After running of the ensembles the archived results (6h forecasts) are processed to generate structure functions by running a program called &#39;festat&#39;. Festat will be run automatically within the SMS system when DTGEND is approached by an experiment and the statistics will be based on difference files generated by intermediate program femars and stored on ecfs in ´ec:/<span>$uid/harmonie/$</span>exp/femars´ (software to generate binary GRIB files of forecasts differences after each cycle). This will mean that if you start by running a one month experiment for January the structure functions generated when you reach DTGEND will be for January. When you use the same experiment name and launch also an experiment for July you will when you reach DTGEND have background error statistics based on both January and July differences files (since both of those are now found in ´ec:/<span>$uid/harmonie/$</span>exp/femars´). These combined winter/summer background error statistics files from phase one are final product from step 1 and can are the intermediate background error statistics files to plug into the HARMONIE-AROME data assimilation of step 2. It should be mentioned that there is a possibility for the more advanced user to run festat off-line and with any combinations of January-July forecast difference files from ´ec:/<span>$uid/harmonie/$</span>exp/femars´. That will be described in ore detail further below and is something you might want to do with forecasts difference files generated from step 2 to produce monthly background error statistics files by combining in different ways.</p><p>In step 2 we run again two one-month ensemble experiments for the same Januar and July months again utilizing ECMWF EDA forecasts as lateral boundary conditions. Again you use 4 ensemble members. The important difference as compared to step 1 is that you now carry out ensemble-data assimilation also within the HARMONIE-AROME framework. You use the background error statistics from phase 1 and do the eda within a data assimilation cycle. This has the important advantage that you significantly reduce spinup caused by the HARMONIE-AROME model adjustments to ECMWF EDA starting initial states. Because of this we can in step 2 derive the statistics from +3h forecast difference (rather than +6 that is used in step 1).      </p><p>Note that there are methods to circumvent step1 and to technically run 3/4DVAR using structure functions derived from another HARMONIE model domain. Such existing methods include aspects such as horizontal truncation or extrapolation of horizontal spectra and possibly vertical interpolation in between vertical level geometries. Since the recommended procedure is to use the two stp approach described above these alternative methods are not described in detail. Furthermore it should be noted that there are background error covariance related tuning coefficients REDNMC and ´REDZONE´. Settings of values of these ae not covered here. If you have a new domain you will use the default value 0.6 for ´REDNMC´ and 100 for ´REDZONE´ which are considered apropiate values for the derivation of structure functions. If you re-derive your statistics for an existing domain you will use the ´REDNMC´ and ´REDZONE´ values as assigned in ´scr/include.ass´.    </p><p>There are various existing tools for investigating your newly derived structure functions and at the end of this page there are some documentation of existing tools and how to use them. </p><p>The procedure for generating structure functions from an ensemble of forecasts is described below for a AROME setup with 2.5 km horizontal resolution and 65 vertical levels. The experiment is run for a one mont winter-period of followed by a one month summer-period on the ECMWF ´ecgb/cca´ computing system. Forecast differences are derived twice a day (00 forecasts from 12 UTC) from combinations of the four ensemble members. Besides the scientific recommendation to cover many different weather situations there is as well a matemathical constraint that the number of forecast difference files provided to festat needs to be larger than the number of vertical levels used in the forecast model integration.  In the section below detailed instructions on how to generate the structure functions are given. The other sections deals with how to diagnose the structure functions recent and ongoing work and future development plans.</p><p>It is recommended for future coming enhancements regarding handling of B statistics and diagnostics of it to save all generated forecast difference files as well as stabal.cv, stabal.cvt and stabal.bal and generated ´.xy´ and ´.y´ files (´.cvt´ ´.xy´ and ´.y´ for diagnotical puroposes):</p><h2 id="Generating-background-error-statistics-(using-43h2.2)"><a class="docs-heading-anchor" href="#Generating-background-error-statistics-(using-43h2.2)">Generating background error statistics (using 43h2.2)</a><a id="Generating-background-error-statistics-(using-43h2.2)-1"></a><a class="docs-heading-anchor-permalink" href="#Generating-background-error-statistics-(using-43h2.2)" title="Permalink"></a></h2><p>The following instructions are valid for trunk and any 43h2.2 tags that have been created. These instructions will only work at ECMWF on ecgate and cca. If you do have a new domain (or are not sure) you should follow that route in step 1 below. New domain creation is described in <a href="../../ExperimentConfiguration/ModelDomain/">ModelDomain</a> which links to the useful <a href="https://hirlam.github.io/nwptools/domain.html">Domain Creation Tool</a> </p><h3 id="STEP-1-Downscaling"><a class="docs-heading-anchor" href="#STEP-1-Downscaling">STEP 1 Downscaling</a><a id="STEP-1-Downscaling-1"></a><a class="docs-heading-anchor-permalink" href="#STEP-1-Downscaling" title="Permalink"></a></h3><ol><li><p>Create a new experiment on ecgate:</p><p>In case you do have an existing domain setup do:</p><pre><code class="nohighlight hljs">mkdir -p $HOME/hm_home/jbdownexp
cd $HOME/hm_home/jbdownexp
~hlam/Harmonie setup -c JBDSC -r /home/ms/spsehlam/hlam/harmonie_release/git/develop -d DOMAIN # where domain is the    name of your domain</code></pre><p>In case  you are creating structure functions for a new domain (or you are not sure):</p><pre><code class="nohighlight hljs">mkdir -p $HOME/hm_home/jbdownexp
cd $HOME/hm_home/jbdownexp
~hlam/Harmonie setup -c JBDSC -r /home/ms/spsehlam/hlam/harmonie_release/git/develop
~hlam/Harmonie co scr/Harmonie_domains.pm</code></pre><p>Then edit scr/Harmonie_domains.pm and add your new domain definition.</p></li><li><p>The ensemble that will be used to generate the structure functions needs to be defined in suites/harmonie.pm. An edited ensemble configuration file should define a four member ensemble that only varies the boundary memeber input (ENSBDMBR) as follows:</p><pre><code class="nohighlight hljs">%env = (
#   &#39;ANAATMO&#39;  =&gt; { 0 =&gt; &#39;3DVAR&#39; },
#   &#39;HWRITUPTIMES&#39; =&gt; { 0 =&gt; &#39;00-21:3,24-60:6&#39; },
#   &#39;SWRITUPTIMES&#39; =&gt; { 0 =&gt; &#39;00-06:3&#39; },
#   &#39;HH_LIST&#39; =&gt; { 0 =&gt; &#39;00-21:3&#39; },
#   &#39;LL_LIST&#39; =&gt; { 0 =&gt; &#39;36,3&#39; },
#   &#39;LSMIXBC&#39;  =&gt; { 0 =&gt; &#39;no&#39; },
#   &#39;ANASURF&#39;  =&gt; { 0 =&gt; &#39;CANARI_OI_MAIN&#39; },
   &#39;ENSCTL&#39;   =&gt; [ &#39;001&#39;, &#39;002&#39;, &#39;003&#39;, &#39;004&#39;],
#   &#39;OBSMONITOR&#39; =&gt; [ &#39;obstat&#39;],
# SLAFLAG: Forecast length to pick your perturbation end point from
# SLAFDIFF: Hours difference to pick your perturbation start point from
# SLAFLAG=24, SLAFDIFF=6 will use +24 - +18
# SLAFDIFF=SLAFLAG will retain the original SLAF construction
# SLAFK should be tuned so that all members have the same perturbation size
   &#39;ENSBDMBR&#39; =&gt; [ 1,2,3,4],
#   &#39;SLAFLAG&#39;  =&gt; [    0,    6,     6,    12,    12,  18,     18,   24,    24,    30,    30],
#   &#39;SLAFDIFF&#39; =&gt; [    0,    6,     6,     6,     6,    6,     6,    6,     6,     6,     6],
#   &#39;SLAFK&#39;    =&gt; [&#39;0.0&#39;,&#39;1.75&#39;,&#39;-1.75&#39;,&#39;1.5&#39;,&#39;-1.5&#39;,&#39;1.2&#39;,&#39;-1.2&#39;,&#39;1.0&#39;,&#39;-1.0&#39;,&#39;0.9&#39;,&#39;-0.9&#39;],
# When using ECMWF ENS the members should be defined
#   # &#39;ENSBDMBR&#39; =&gt; [ 0, 1..10],

### Normally NO NEED to change the settings below</code></pre></li><li><p>Run for two one-month (30 day) periods:</p><pre><code class="nohighlight hljs">cd $HOME/hm_home/jbdownexp
~hlam/Harmonie start DTG=2016060100 DTGEND=2016070100
#
#~hlam/Harmonie start DTG=2017010100 DTGEND=2017013100</code></pre></li><li><p>Generate the statistics using festat standalone:</p><ul><li>Place yourself at TEMP on cca</li><li>Copy [https://hirlam.org/trac/attachment/wiki/HarmonieSystemDocumentation/Structurefunctions_ensys   /Festat.standalone Festat.standalone] to TEMP at cca</li><li>Edit the script to reflect your user and experiment details (in particular copy femars data ec:/uid/harmonie /jbdownexp/femars/ yo femars-directory on TEMP)</li></ul><p>submit with</p><pre><code class="nohighlight hljs">qsub ./Festat.standalone</code></pre><p>(you will get a log-file ´festat.log´ on ´TEMP´ and results in directory ´festat_wrk´) when the program has finished do:</p><pre><code class="nohighlight hljs">cd festat_wrk
emkdir ec:/$uid/jbdata
gzip stab_your_exp.cv
gzip stab_your_exp.bal
ecp stab_your_exp.cv.gz ec:/$uid/jbdata/.  (with your own filename and directory)
ecp stab_your_exp.bal.gz ec:/$uid/jbdata/. (with your own filename and directory)</code></pre><p>(also create a tar.file with all ´<em>.xy´ ´</em>.y´ ´<em>.cv´, ´</em>.bal´ and ´*.cvt´ and put on ecfs for future diagnostical purposes) </p></li></ol><h3 id="STEP-2-Generating-background-error-statistics-with-EDA-cycling-(instructions-under-testing)"><a class="docs-heading-anchor" href="#STEP-2-Generating-background-error-statistics-with-EDA-cycling-(instructions-under-testing)">STEP 2 Generating background error statistics with EDA cycling (instructions under testing)</a><a id="STEP-2-Generating-background-error-statistics-with-EDA-cycling-(instructions-under-testing)-1"></a><a class="docs-heading-anchor-permalink" href="#STEP-2-Generating-background-error-statistics-with-EDA-cycling-(instructions-under-testing)" title="Permalink"></a></h3><ol><li><p>Create a new experiment on ecgate:</p><p>In case you do have an existing domain setup do:</p><pre><code class="nohighlight hljs">mkdir -p $HOME/hm_home/jbedaexp
cd $HOME/hm_home/jbedaexp
~hlam/Harmonie setup -c AROME_JBEDA -r /home/ms/spsehlam/hlam/harmonie_release/git/develop -d DOMAIN # where domain    is the name of your domain</code></pre><p>In case  you are creating structure functions for a new domain (or you are not sure):</p><pre><code class="nohighlight hljs">mkdir -p $HOME/hm_home/jbedanexp
cd $HOME/hm_home/jbedaexp
~hlam/Harmonie setup -c AROME_JBEDA -r /home/ms/spsehlam/hlam/harmonie_release/git/develop
~hlam/Harmonie co scr/Harmonie_domains.pm</code></pre><p>Then edit ´scr/Harmonie_domains.pm´ and add your new domain definition.</p></li><li><p>The ensemble that will be used to generate the structure functions needs to be defined in suites/harmonie.pm. An edited ensemble configuration file should define a four member ensemble that only varies the boundary memeber input (ENSBDMBR) as follows:</p><pre><code class="nohighlight hljs">%env = (
#   &#39;ANAATMO&#39;  =&gt; { 0 =&gt; &#39;3DVAR&#39; },
#   &#39;HWRITUPTIMES&#39; =&gt; { 0 =&gt; &#39;00-21:3,24-60:6&#39; },
#   &#39;SWRITUPTIMES&#39; =&gt; { 0 =&gt; &#39;00-06:3&#39; },
#   &#39;HH_LIST&#39; =&gt; { 0 =&gt; &#39;00-21:3&#39; },
#   &#39;LL_LIST&#39; =&gt; { 0 =&gt; &#39;36,3&#39; },
#   &#39;LSMIXBC&#39;  =&gt; { 0 =&gt; &#39;no&#39; },
#   &#39;ANASURF&#39;  =&gt; { 0 =&gt; &#39;CANARI_OI_MAIN&#39; },
   &#39;ENSCTL&#39;   =&gt; [ &#39;001&#39;, &#39;002&#39;, &#39;003&#39;, &#39;004&#39;],
#   &#39;OBSMONITOR&#39; =&gt; [ &#39;obstat&#39;],   
# SLAFLAG: Forecast length to pick your perturbation end point from
# SLAFDIFF: Hours difference to pick your perturbation start point from
# SLAFLAG=24, SLAFDIFF=6 will use +24 - +18
# SLAFDIFF=SLAFLAG will retain the original SLAF construction
# SLAFK should be tuned so that all members have the same perturbation size
   &#39;ENSBDMBR&#39; =&gt; [ 1,2,3,4],
#   &#39;SLAFLAG&#39;  =&gt; [    0,    6,     6,    12,    12,  18,     18,   24,    24,    30,    30],
#   &#39;SLAFDIFF&#39; =&gt; [    0,    6,     6,     6,     6,    6,     6,    6,     6,     6,     6],
#   &#39;SLAFK&#39;    =&gt; [&#39;0.0&#39;,&#39;1.75&#39;,&#39;-1.75&#39;,&#39;1.5&#39;,&#39;-1.5&#39;,&#39;1.2&#39;,&#39;-1.2&#39;,&#39;1.0&#39;,&#39;-1.0&#39;,&#39;0.9&#39;,&#39;-0.9&#39;],
# When using ECMWF ENS the members should be defined
#   # &#39;ENSBDMBR&#39; =&gt; [ 0, 1..10],

### Normally NO NEED to change the settings below</code></pre></li><li><p>Link to your newly generated Jb statistics from STEP1  :</p><p>Edit in ´HOME/hm_home/jbedaexp/scr/include.ass´ as follows (example for ´DOMAIN=METCOOP25D´): In the section for your relevant domain point to the structure function stored in STEP one as follows:</p><pre><code class="nohighlight hljs"> elif [ &quot;$DOMAIN&quot; = YOUR DOMAIN]; then
   JBDIR=${JBDIR-&quot;ec:/hirlam/harmonie_jbdata&quot;}
   JBDIR=ec:/$uid/jbdata
   f_JBCV=stabfiltn_your_exp.cv_jbconv.cv (without .gz)
   f_JBBAL=stabfiltn_your_exp.bal_jbconv.bal (without.gz)</code></pre></li><li><p>Run for two one-month (30 day) periods:</p><pre><code class="nohighlight hljs">cd $HOME/hm_home/jbedaexp
~hlam/Harmonie start DTG=2016060100 DTGEND=2016070100
#
#~hlam/Harmonie start DTG=2017010100 DTGEND=2017013100</code></pre></li><li><p>Generate the statistics using festat standalone:</p><ul><li>Place yourself at TEMP on cca</li><li>Copy <a href="https://opensource.umr-cnrm.fr/attachments/4999/Festat.standalone">Festat.standalone</a> to ´TEMP´ at cca</li><li>Edit the script to reflect your user and experiment details (in particular copy femars data ´ec:/<span>$uid/harmonie/jbdownexp/femars/´ to femars-directory on ´$</span>TEMP´)</li><li>Make sure you have removed old femars_wrk directory and only have forecast differences from you EDA experiment in   your femars directory As well preferably name files differently than in STEP 1 downscaling. </li></ul></li></ol><p>submit with    <code>qsub ./Festat.standalone</code>    (you will get a log-file festat.log on TEMP and results in directory festat<em>wrk)    when the program has finished do:    ```    cd festat</em>wrk    emkdir ec:/smx/jbdata (with smx replaced with your own user id)     gzip stab<em>your</em>eda<em>exp.cv    gzip stab</em>your<em>eda</em>exp.bal    ecp stab<em>your</em>eda<em>exp.cv.gz ec:/smx/jbdata/.  (with your own filename and directory)    ecp stab</em>your<em>eda</em>exp.bal.gz ec:/smx/jbdata/. (with your own filename and directory)    ```    (also create a tar.file with all ´<em>.xy´ ´</em>.y´ ´<em>.cv´, ´</em>.bal´ and ´*.cvt´ and put on ecfs for future diagnostical purposes)    These new files are you final background error statistics to be diagnosed (compared with STEP 1 ones perhaps) and     inserted to your data assimilation by modyfying include.ass (as in bullet 3 above) to point to your new files. </p><h2 id="Diagnosis-of-background-error-statistics"><a class="docs-heading-anchor" href="#Diagnosis-of-background-error-statistics">Diagnosis of background error statistics</a><a id="Diagnosis-of-background-error-statistics-1"></a><a class="docs-heading-anchor-permalink" href="#Diagnosis-of-background-error-statistics" title="Permalink"></a></h2><ol><li><p>Diagnosis of background error statistics is a rather complicated task. To get an idea of what the correlations and covariances should look like take a look in the article: Berre, L., 2000: Estimation of synoptic and meso scale forecast error covariances in a limited area model. Mon. Wea. Rev., 128, 644-667. Software for investigating and graphically illustrate different aspects of the background error statistics has been developed and statistics generated for different domains has been investigated using the <a href="https://github.com/Hirlam/AccorDaTools">AccordDaTools</a> package. With this software you can also compare your newly generated background error statistics with the one generated for other HARMONIE domains. This will give you and idea if your statistics seems reasonable. For diagnosing the newly derived background error statistics follow these instructions:</p></li><li><p>Get the code and scripts:</p><ul><li>Download and install !AccordDaTools following instructions in the [https://github.com/Hirlam/AccordDaTools#readme README]</li><li>Don&#39;t forget to add the package tools directory to your PATH: </li><li><code>export PATH=/path/to/da_tools:$PATH</code></li></ul></li><li><p>Run Jb diagnostics script:</p><ul><li>For example for a new domain using horizontal grid-spacing of 2500 m and (Harmonie) 65 vertical levels:<pre><code class="nohighlight hljs">#!sh
$!&gt; jbdiagnose -b jb_data/stab_IRELAND25_064_480.bal -c jb_data/stab_IRELAND25_064_480.cv -g 2500 -l harmL65 -e jbdiag_IRELAND25_064</code></pre></li><li>The output will be made written to ´jbdiag<em>IRELAND25</em>064´</li></ul></li><li><p>The !AccordDoTools package also provides two tools for plotting the data produced by ´jbdiagnose´, ´plotjbbal´ and ´plotjbdiag´. ´plotjbbal´ plots Jb balances for different parameters. ´plotjbdiag´ produces spectral density (spdens) and vertical correlation (vercor) diagnostic plots for your structure funtions. For example:</p><ul><li>plotjbbal:<pre><code class="nohighlight hljs">#!sh
$~&gt; plotjbbal -t stdv -p QQ -r jbdiag_ -e IRELAND25_064</code></pre></li><li>plotjbdiag:<pre><code class="nohighlight hljs">#!sh
$~&gt; plotjbdiag -l 50 -t vercor -p QQ -r jbdiag_ -e IRELAND25_064</code></pre></li></ul></li></ol><h2 id="Run-3DVAR/4DVAR-with-the-new-background-error-statistics"><a class="docs-heading-anchor" href="#Run-3DVAR/4DVAR-with-the-new-background-error-statistics">Run 3DVAR/4DVAR with the new background error statistics</a><a id="Run-3DVAR/4DVAR-with-the-new-background-error-statistics-1"></a><a class="docs-heading-anchor-permalink" href="#Run-3DVAR/4DVAR-with-the-new-background-error-statistics" title="Permalink"></a></h2><ol><li>create ´hm<em>home/jb</em>da´. Then ´cd HOME/hm<em>home/jb</em>da´.</li><li>create experiment by typing ´~hlam/Harmonie setup -r /home/ms/spsehlam/hlam/harmonie_release/git/develop´. </li><li>In scr/include.ass set ´JBDIR=ec:/<span>$uid/jbdata´ (uid being your userid, in this example &#39;ec:/smx/jbdata&#39;) and  f_JBCV=&#39;name of your ´.cv´ file in ´ec:/$</span>uid/jbdata´ (without ´.gz´) and f<em>JBBAL is &#39;name of your ´.bal´ file in ´ec:/uid/jbdata´  (without ´.gz´)  (in this example, ´f</em>JBCV=stab<em>METCOOPD</em>65<em>20200601</em>360.cv´, ´stab<em>METCOOPD</em>65<em>20200601</em>360.bal´).  Add these three lines instead of the three lines in include.ass that follows right after the elif statement: ´elif [ &quot;DOMAIN&quot; = METCOOP25D]; then´. If domain is other than ´METCOOP25D´ one has to look for the alternative name of the domain. </li><li>From ´HOME/hm<em>home/jb</em>da´ launch experiment by typing<pre><code class="nohighlight hljs">~hlam/Harmonie start DTG=2021010100 DTGEND=2021010103</code></pre></li><li>The resulting analysis file be found on cca (ssh cca) under <span>$TEMP/hm_home/jb_da/archive/2021/01/01/03 and it will be called &#39;MXMIN1999+0000&#39; and on and ec:/$</span>uid/harmonie/2021/01/01/03. To diagnose the 3D-VAR analysis increments of the jb<em>da-experiment, copy the files MXMIN1999+0000 (analysis) and ICMSHHARM+0003 (fg) to SCRATCH. The first guess (background) file can be found on TEMP/hm</em>home/jb<em>da/archive/2021/01/01/00 and ec:/uid/harmonie/jb</em>da/2021/01/01/00.  Convert from FA-file format to GRIB with the gl-software (SCRATCH/hm<em>home/jb</em>da/bin/gl) by typing &#39;./gl -p MXMIN1999+0000&#39; and &#39;./gl -p ICMSHANAL+0000&#39;. Then plot the difference between files file with your favorite software. Plot horizontal and vertical cross-sections of temperature and other variables using your favourite software (epygram for example).</li><li>Now you have managed to insert the newly generated background error statistics to the assimilation system and managed to carry out a full scale data assimilation system and plot the analysis increments. The next natural step to further diagnose the background error statistics is to carry out a <a href="../SingleObs/">single observation impact experiment</a>, utilizing your newly generated background error statistics. Note the variables ´REDNMC´ and ´REDZONE´ in include.ass. ´REDNMC´ is the scaling factor for the background error statistics (default value 0.6/0.9) for ´METCOOP25D/NEW<em>DOMAIN´). ´REDZONE´ described how far from the lateral boundaries (in km) the observations need to be located to be assimilated (default value 150/100) for ´METCOOP25D/NEW</em>DOMAIN´.</li></ol><h2 id="In-line-Interpolation-and-Extrapolation-of-Jb-statistics"><a class="docs-heading-anchor" href="#In-line-Interpolation-and-Extrapolation-of-Jb-statistics">In-line Interpolation and Extrapolation of Jb-statistics</a><a id="In-line-Interpolation-and-Extrapolation-of-Jb-statistics-1"></a><a class="docs-heading-anchor-permalink" href="#In-line-Interpolation-and-Extrapolation-of-Jb-statistics" title="Permalink"></a></h2><p>In case you do not have existing background error statistics derived for your domain there is a built technical possibility to use Jb-files from another domain derived with the same number of vertical levels. From this host Jb-files background error statistics are then interpolated or extrapolated to the current domain configuration. The assumption is then (which is in general questionable) that the statistics derived derived on the host domain is as well valid for the current domain. If the longest side of the host domain is shorter than the longest side of the current domain an extrapolation of background error covariance spectra is needed. Such extrapolation should be avoided over a wide range of wavenumbers. Therefore it is recommended that the longest side of the host Jb-file is as long or longer than the longest side of the current domain.The interpolation is invoked by in ecf/config<em>exp.h set ´JB</em>INTERPOL=yeś´ and ´JB<em>REF</em>DOMAIN=<span>$HOST_JB´, where ´$</span>HOST<em>JB´ is for example ´METCOOP25B´. These settings will activate runnning of script ´jbconv.sh´ (in case no Jb files present for current domain), called from &#39;Fetch</em>assim_data&#39;. </p><h2 id="On-going-work-and-future-developments"><a class="docs-heading-anchor" href="#On-going-work-and-future-developments">On-going work &amp; future developments</a><a id="On-going-work-and-future-developments-1"></a><a class="docs-heading-anchor-permalink" href="#On-going-work-and-future-developments" title="Permalink"></a></h2><p>Recent and on-going work as well as plans for future developments:</p><ul><li>Ongoing-work regarding structure functions concerns investigations of effects on B statistics and data assimilation of the upper-level relaxation towards ecmwf at upper boundary condition through ´LUNBC=.true.´ Longer term research is towards flow dependent background error statistics and close link between the data assimilation and the ensemble forecasting system. Plans for future work also include adopting towards use of cy46 <a href="https://opensource.umr-cnrm.fr/attachments/4999/Festat.standalone">Festat.standalone</a>, reading FA-files rather than femars-files. Here is a newly developed stand-alone tool for interpolation in of Jb-statistics as well between different vertical levels (not recommended) not yet publicly available and documented. Finally it should be mentioned that there are alternative methods to ´EDA´ for carrying out STEP 2 of teh background error statistics derivation. Such alternatives are ´BRAND´ and ´BREND´ and these have been tested and compared with ´EDA´ in various contexts, such as in reanalysis frameworks. The conclusion is that there are both pros and cons with ´BRAND´ as compared with ´EDA´. The main conclusion is that both ´EDA´and ´BRAND´ are hampered by the homogeneity and isotrophy assumptions in 3DVAR/4DVAR framework, so that differences are smaller than in hybrid DA frameworks. Therefore continued ´EDA/BRAND´ comparisons are carried out withing hybrid ensemble/da frameworks. Nevertherless we aim here to include as well instructions for optionally replacing STEP 2 ´EDA´ in procedure above with STEP 2 ´BRAND´. As well we aim for introducing instructions for using extended complementary diagnosis tools for Jb statistics using fediacov tool and associated plotting scripts. Such tools do exist, but not yet publicly available and documented   </li></ul><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><ul><li><a href="https://opensource.umr-cnrm.fr/attachments/5000/festat_guidelines.pdf">festat_guidelines</a>, Ryad El Katib, Meteo France, 2014</li><li><a href="https://opensource.umr-cnrm.fr/attachments/4279/festat_for_fa.pdf">festat<em>for</em>fa_guidelines</a>, Ryad El Katib, Meteo France, 2016</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Screening/">« Screening</a><a class="docs-footer-nextpage" href="../DataAssimilation4DVAR/">4DVAR »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Wednesday 25 January 2023 15:20">Wednesday 25 January 2023</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
