<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>CMake Â· Harmonie wiki</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-221448594-1"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-221448594-1', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://hirlam.github.io/HarmonieSystemDocumentation/dev/Build/Build_with_cmake/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Harmonie wiki logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Harmonie wiki</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../System/GitDeveloperDocumentation/">GitHub workflow</a></li><li><a class="tocitem" href="../../Overview/da_graph/">Graphical Overview</a></li><li><a class="tocitem" href="../../System/RunningHarmonieOnAtos/">Running on Atos</a></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Overview</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Overview/Content/">Content</a></li><li><a class="tocitem" href="../../Overview/Binaries/">Binaries</a></li><li><a class="tocitem" href="../../Overview/FileFormats/">File Formats</a></li><li><a class="tocitem" href="../../Overview/Source/">Source</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-5" type="checkbox"/><label class="tocitem" for="menuitem-2-5"><span class="docs-label">Experiment Configuration</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ExperimentConfiguration/ConfigureYourExperiment/">Experiment</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/Namelists/">Namelist</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/UseofObservation/">Observations</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/PlatformConfiguration/">Platform</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/How_to_use_hires_topography/">HiRes Topography</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/ModelDomain/">Domain</a></li><li><a class="tocitem" href="../../ExperimentConfiguration/VerticalGrid/">Vertical Grid</a></li></ul></li></ul></li><li><span class="tocitem">NWP Components</span><ul><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Observations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1-1"><span class="docs-label">Preprocessing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Observations/ObservationPreprocessing/">Preprocessing</a></li><li><a class="tocitem" href="../../Observations/Oulan/">Oulan</a></li><li><a class="tocitem" href="../../Observations/Bator/">Bator</a></li><li><a class="tocitem" href="../../Observations/Cope/">Cope</a></li><li><a class="tocitem" href="../../Observations/ObservationData/">ObservationData</a></li><li><a class="tocitem" href="../../Observations/Conrad/">Conrad</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-1-2" type="checkbox"/><label class="tocitem" for="menuitem-3-1-2"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Observations/SYNOP/">SYNOP</a></li><li><a class="tocitem" href="../../Observations/Amv/">AMV</a></li><li><a class="tocitem" href="../../Observations/Iasi/">IASI</a></li><li><a class="tocitem" href="../../Observations/Atovs/">ATOVS</a></li><li><a class="tocitem" href="../../Observations/Scatt/">Scatt</a></li><li><a class="tocitem" href="../../Observations/Ascat/">AScat</a></li><li><a class="tocitem" href="../../Observations/GNSS/">GNSS</a></li><li><a class="tocitem" href="../../Observations/Modes/">Modes</a></li><li><a class="tocitem" href="../../Observations/RadarData/">Radar</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Data Assimilation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-2-1" type="checkbox"/><label class="tocitem" for="menuitem-3-2-1"><span class="docs-label">Surface</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI/">CANARI</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI_OI_MAIN/">CANARI OI MAIN</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/CANARI_EKF_SURFEX/">CANARI EKF SURFEX</a></li><li><a class="tocitem" href="../../DataAssimilation/Surface/SurfaceAnalysis/">Surface Analysis</a></li></ul></li><li><a class="tocitem" href="../../DataAssimilation/Screening/">Screening</a></li><li><a class="tocitem" href="../../DataAssimilation/StructureFunctions/">Structure functions</a></li><li><a class="tocitem" href="../../DataAssimilation/DataAssimilation4DVAR/">4DVAR</a></li><li><a class="tocitem" href="../../DataAssimilation/DigitalFilterInitialization/">Digital Filter Initialization</a></li><li><a class="tocitem" href="../../DataAssimilation/ObservationOperators/">HOP_DRIVER</a></li><li><a class="tocitem" href="../../DataAssimilation/SingleObs/">Single Obs</a></li><li><a class="tocitem" href="../../DataAssimilation/LSMIXandJk/">LSMIX and Jk</a></li><li><a class="tocitem" href="../../DataAssimilation/DFS/">DFS</a></li><li><a class="tocitem" href="../../DataAssimilation/MTEN/">MTEN</a></li><li><a class="tocitem" href="../../DataAssimilation/CHKEVO/">CHKEVO</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Boundaries</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Boundaries/BoundaryFilePreparation/">Preparation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Forecast Model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ForecastModel/Forecast/">Forecast</a></li><li><a class="tocitem" href="../../ForecastModel/Outputlist/">Output List</a></li><li><a class="tocitem" href="../../ForecastModel/HR/">High Res</a></li><li><input class="collapse-toggle" id="menuitem-3-4-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4-4"><span class="docs-label">Single Column Model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC/">MUSC</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/Forcing/">Forcing</a></li><li><a class="tocitem" href="../../ForecastModel/SingleColumnModel/MUSC_vars/">MUSC vars</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Climate Generation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ClimateGeneration/ClimateGeneration/">Climate Generation</a></li><li><a class="tocitem" href="../../ClimateGeneration/DownloadInputData/">Input Data</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">EPS</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../EPS/Howto/">Howto</a></li><li><a class="tocitem" href="../../EPS/System/">System</a></li><li><a class="tocitem" href="../../EPS/BDSTRATEGY/">BDSTRATEGY</a></li><li><a class="tocitem" href="../../EPS/SLAF/">SLAF</a></li><li><a class="tocitem" href="../../EPS/SPP/">SPP</a></li><li><a class="tocitem" href="../../EPS/SPPT/">SPPT</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-7" type="checkbox"/><label class="tocitem" for="menuitem-3-7"><span class="docs-label">Post Processing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../PostProcessing/Diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../../PostProcessing/FileConversions/">FileConversions</a></li><li><a class="tocitem" href="../../PostProcessing/Fullpos/">FullPos</a></li><li><a class="tocitem" href="../../PostProcessing/gl/">GL</a></li><li><a class="tocitem" href="../../PostProcessing/xtool/">xtool</a></li><li><a class="tocitem" href="../../PostProcessing/PostPP/">PostPP</a></li><li><a class="tocitem" href="../../PostProcessing/Interpolation/">Interpolation GL</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-8" type="checkbox"/><label class="tocitem" for="menuitem-3-8"><span class="docs-label">Verification</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Verification/Extract4verification/">Extract4verification</a></li><li><a class="tocitem" href="../../Verification/Verification/">Verification</a></li><li><a class="tocitem" href="../../Verification/HARP/">HARP</a></li><li><a class="tocitem" href="../../Verification/Obsmon/">Obsmon</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-9" type="checkbox"/><label class="tocitem" for="menuitem-3-9"><span class="docs-label">Visualization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Visualization/EPyGrAM/">EpyGram</a></li></ul></li></ul></li><li><span class="tocitem">System</span><ul><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox" checked/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Build</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../General/">Software requirements</a></li><li><a class="tocitem" href="../Build_with_makeup/">Makeup</a></li><li class="is-active"><a class="tocitem" href>CMake</a><ul class="internal"><li><a class="tocitem" href="#Background"><span>Background</span></a></li><li><a class="tocitem" href="#Getting-started-with-CMake"><span>Getting started with CMake</span></a></li><li><a class="tocitem" href="#Configuration-files"><span>Configuration files</span></a></li><li><a class="tocitem" href="#Using-environment-variables-in-JSON-configuration-files"><span>Using environment variables in JSON configuration files</span></a></li><li><a class="tocitem" href="#Note-on-the-structure-of-the-JSON-configuration-files"><span>Note on the structure of the JSON configuration files</span></a></li><li><a class="tocitem" href="#Note-on-the-auto-double-flags"><span>Note on the auto-double flags</span></a></li><li><a class="tocitem" href="#Note-on-generating-different-build-systems-with-CMake"><span>Note on generating different build systems with CMake</span></a></li><li><a class="tocitem" href="#Practical-considerations"><span>Practical considerations</span></a></li></ul></li><li><a class="tocitem" href="../gmkpack/">Gmkpack</a></li><li><a class="tocitem" href="../Gmkpack_vs_Make/">Gmkpack vs Make</a></li><li><a class="tocitem" href="../CompileHarmonie/">Compile Harmonie</a></li><li><a class="tocitem" href="../Installation/">Installation</a></li><li><a class="tocitem" href="../Redhat7Install/">Redhat7 Install</a></li><li><a class="tocitem" href="../Centos6Install/">Centos6 Install</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Phasing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../System/MFaccess/">MF Access</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Suite Management</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../SuiteManagement/ECFLOW/">ECFLOW</a></li></ul></li><li><a class="tocitem" href="../../System/TheHarmonieScript/">The Harmonie script</a></li><li><a class="tocitem" href="../../System/Fast_start_on_cca/">Fast start on cca</a></li><li><a class="tocitem" href="../../System/QuickStartLocal/">Local</a></li><li><a class="tocitem" href="../../System/HarmonieTestbed/">Testbed</a></li><li><a class="tocitem" href="../../System/ECMWF_teleport/">Teleport</a></li><li><a class="tocitem" href="../../System/Build_local_docs/">Local Documentation</a></li><li><a class="tocitem" href="../../System/DrHook/">DrHook</a></li><li><a class="tocitem" href="../../System/StandaloneOdb/">Stand alone ODB</a></li><li><a class="tocitem" href="../../System/UpdateNamelists/">Update Namelist</a></li><li><a class="tocitem" href="../../System/Scalability_and_Refactoring/">Scalability and refactoring</a></li><li><a class="tocitem" href="../../System/HarmonieBenchMark/">Benchmark</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">System</a></li><li><a class="is-disabled">Build</a></li><li class="is-active"><a href>CMake</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>CMake</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Hirlam/Harmonie/blob/dev-CY46h1/docs/src/Build/Build_with_cmake.md" title="Edit on GitHub"><span class="docs-icon fab">ï</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Build-with-CMake"><a class="docs-heading-anchor" href="#Build-with-CMake">Build with CMake</a><a id="Build-with-CMake-1"></a><a class="docs-heading-anchor-permalink" href="#Build-with-CMake" title="Permalink"></a></h1><h2 id="Background"><a class="docs-heading-anchor" href="#Background">Background</a><a id="Background-1"></a><a class="docs-heading-anchor-permalink" href="#Background" title="Permalink"></a></h2><p>CMake is a build system generator supporting multiple build systems and programming languages, specifically Fortran is a first-class citizen there, allowing, for example, out-of-the-box handling of the inter-module dependencies. A <em>build system generator</em> there means that description of the build procedure written in the CMake-script language is used by the <code>cmake</code> tool to generate the actual build system, for example using <code>Unix Makefiles</code> or <code>Ninja</code> generator. Thus, all modifications should be performed on the CMake-script level and not within the generated build system as these changes will be overwritten when re-running <code>cmake</code> at some point.</p><p>Why providing yet another alternative for building HARMONIE-AROME? Well, <code>makeup</code> does a very good job building the system, however it&#39;s an in-house solution which has a number of limitations:</p><ul><li><code>makeup</code> is an in-house build system, so there are components that require more maintenance compared to a standardized build tool</li><li><code>makeup</code> uses a considerable number of sequential steps, which increase the total build time</li><li>the <code>configure</code> step takes quite some time, although in some cases it can be skipped, but users have to remember when they <em>must</em> re-run <code>configure</code> and this dependency is not enforced by <code>makeup</code></li><li>not all the dependencies are tracked by <code>makeup</code>, for example updating configure files does not trigger a re-build</li></ul><p>In an attempt to fix these limitation of <code>makeup</code>, CMake was chosen as an alternative. CMake has a mature Fortran support and improves upon some shortcomings of <code>makeup</code> with little effort (well, it obviously has its own fair share of quirks, but that&#39;s a different story...). Additionally, using CMake allows us to enforce usage requirements and dependencies between different components of HARMONIE-AROME, for example, it&#39;s a good idea to ensure that SURFEX routines do not directly call cloud microphysics functions. Currently <code>makeup</code> does not enforce these boundaries and this task is left to the developers who implement the new code. Of course, something like this can also be implemented with <code>makeup</code>, but it would require considerable development efforts.</p><h2 id="Getting-started-with-CMake"><a class="docs-heading-anchor" href="#Getting-started-with-CMake">Getting started with CMake</a><a id="Getting-started-with-CMake-1"></a><a class="docs-heading-anchor-permalink" href="#Getting-started-with-CMake" title="Permalink"></a></h2><h3 id="Selecting-the-CMake-based-build-system-when-installing-HARMONIE-AROME"><a class="docs-heading-anchor" href="#Selecting-the-CMake-based-build-system-when-installing-HARMONIE-AROME">Selecting the CMake-based build system when installing HARMONIE-AROME</a><a id="Selecting-the-CMake-based-build-system-when-installing-HARMONIE-AROME-1"></a><a class="docs-heading-anchor-permalink" href="#Selecting-the-CMake-based-build-system-when-installing-HARMONIE-AROME" title="Permalink"></a></h3><p>If all the config files are available, building HARMONIE-AROME with CMake should be as simple as setting the <code>BUILD_WITH</code> variable when invoking <code>Harmonie</code>:</p><pre><code class="language-bash hljs">config-sh/Harmonie install BUILD_WITH=cmake</code></pre><p>or alternatively, setting the desired option in <code>ecf/config_exp.h</code>.</p><h3 id="Building-HARMONIE-AROME-with-CMake-from-the-command-line"><a class="docs-heading-anchor" href="#Building-HARMONIE-AROME-with-CMake-from-the-command-line">Building HARMONIE-AROME with CMake from the command line</a><a id="Building-HARMONIE-AROME-with-CMake-from-the-command-line-1"></a><a class="docs-heading-anchor-permalink" href="#Building-HARMONIE-AROME-with-CMake-from-the-command-line" title="Permalink"></a></h3><p>Sometimes calling <code>Harmonie install</code> is not the best choice and one might want to compile the code from the command line. In this case compilation of HARMONIE-AROME with CMake consists of three individual steps:</p><ol><li>compiling the auxiliary libraries (<code>gribex</code> and such)</li><li>compiling the main code of HARMONIE-AROME</li><li>optionally, compile some additional tools (for example, <code>gl</code>)</li></ol><h4 id=".-Compiling-the-auxiliary-libraries"><a class="docs-heading-anchor" href="#.-Compiling-the-auxiliary-libraries">1. Compiling the auxiliary libraries</a><a id=".-Compiling-the-auxiliary-libraries-1"></a><a class="docs-heading-anchor-permalink" href="#.-Compiling-the-auxiliary-libraries" title="Permalink"></a></h4><p>This step is rather straightforward, assuming that HARMONIE-AROME code is located under the path stored in the <code>HM_LIB</code> environment variable one can adapt the following snippet to compile all the required libraries:</p><pre><code class="language-bash hljs">CMAKE_FLAGS=&quot;-DCONFIG_FILE=&lt;path to your JSON config&gt;&quot;
INSTALL_DIR=&quot;&lt;directory where the auxiliary libraries should be installed&gt;&quot;

AUX_LIBS=&#39;bufr_405 gribex_370 rgb_001 dummies_006/mpidummy&#39;
for project in $AUX_LIBS; do
  echo &quot;Compiling $project&quot;
  current_project_dir=$HM_LIB/util/auxlibs/$project
  current_build_dir=&quot;build-`echo $project | sed &#39;s|/|-|g&#39;`&quot;

  mkdir -p $current_build_dir &amp;&amp; cd $current_build_dir

  # CMake build type can be changed to Debug, if needed
  cmake $current_project_dir -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR $CMAKE_FLAGS
  # Here -j tells CMake how many parallel compilation processes to use
  cmake --build . --target install -j16

  cd ..
done</code></pre><p>If a specific config file is not there, you can try your luck with using generic config files provided for different compiler types. To do so, just drop the <code>-DCONFIG_FILE</code> from the list of CMake command line arguments and CMake will try to load a suitable configuration file, if available.</p><h4 id=".-Compiling-the-main-code-of-HARMONIE-AROME"><a class="docs-heading-anchor" href="#.-Compiling-the-main-code-of-HARMONIE-AROME">2. Compiling the main code of HARMONIE-AROME</a><a id=".-Compiling-the-main-code-of-HARMONIE-AROME-1"></a><a class="docs-heading-anchor-permalink" href="#.-Compiling-the-main-code-of-HARMONIE-AROME" title="Permalink"></a></h4><p>Following the procedure described in the previous step, one can use a similar approach to compile the main code (here, one of the generic configuration files is used, of course it can be replaced with a different one or dropped but it should be the same config file which was used to compile auxiliary libraries):</p><pre><code class="language-bash hljs">mkdir build &amp;&amp; cd build
# Configure and generate the build system
cmake $HM_LIB/src \
  -G Ninja # Use Ninja to build HARMONIE-AROME, drop to build with Makefiles
  -DCMAKE_BUILD_TYPE=Release \
  -DCONFIG_FILE=$HM_LIB/util/util/cmake/config.GNU.cmake \
  -Dbufr_DIR=$INSTALL_DIR/lib/cmake/bufr \
  -Dgribex_DIR=$INSTALL_DIR/lib/cmake/gribex \
  -Drgb_DIR=$INSTALL_DIR/lib/cmake/rgb \
  -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR

# Build and install HARMONIE-AROME
cmake --build . --target install -j16</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Obviously, when compiling from command line, additional command line arguments might be provided to CMake at the configure step as needed. However, a preferred solution is to use a configuration file to handle as much of the machine-specific details as possible.</p></div></div><h4 id=".-Compiling-the-tools"><a class="docs-heading-anchor" href="#.-Compiling-the-tools">3. Compiling the tools</a><a id=".-Compiling-the-tools-1"></a><a class="docs-heading-anchor-permalink" href="#.-Compiling-the-tools" title="Permalink"></a></h4><p>The approach is the same as with the main code, however, you might want to add <code>-Dharmonie_DIR=$INSTALL_DIR/lib/cmake/harmonie</code> if the tool in question needs HARMONIE-AROME libraries for compilation.</p><h2 id="Configuration-files"><a class="docs-heading-anchor" href="#Configuration-files">Configuration files</a><a id="Configuration-files-1"></a><a class="docs-heading-anchor-permalink" href="#Configuration-files" title="Permalink"></a></h2><p>Configuration files, similarly to <code>makeup</code>, are used to provide compilation flags, define external libraries to use when compiling the code et cetera. Thus, having a correct configuration file is one of the key elements of successful building HARMONIE-AROME. The CMake-based build system of HARMONIE-AROME uses configuration files written in JSON format. JSON was chosen to make these files more declarative and, hopefully, easier to maintain and modify than plain CMake-script-based files would be.</p><p>The main config file, which is used to build auxiliary libraries and the main HARMONIE-AROME code should be placed under <code>util/cmake/config</code> directory. This file has a following top-level structure:</p><pre><code class="language-json hljs">{
  &quot;build_tools&quot;:[],
  &quot;dependencies&quot;:[],
  &quot;programs&quot;:[],
  &quot;configure&quot;:{},
  &quot;compile&quot;:[],
  &quot;compile_single&quot;:[],
  &quot;compile_double&quot;:[],
  &quot;custom_compile&quot;:{},
  &quot;link&quot;:[]
}</code></pre><p>there all the sections except <code>configure</code>, <code>custom_compile</code> and <code>link</code> are mandatory. In the following a detailed description of all the config file section is provided.</p><h3 id="The-build_tools-section"><a class="docs-heading-anchor" href="#The-build_tools-section">The <code>build_tools</code> section</a><a id="The-build_tools-section-1"></a><a class="docs-heading-anchor-permalink" href="#The-build_tools-section" title="Permalink"></a></h3><p>This section lists the external tools required for compiling HARMONIE-AROME,  excluding compilers. Currently, this section should always contain the two following entries: <code>FLEX</code> and <code>BISON</code>, but in future this list might be extended. So, currently this section is always defined as:</p><pre><code class="language-json hljs">&quot;build_tools&quot;:[&quot;BISON&quot;, &quot;FLEX&quot;]</code></pre><h3 id="The-dependencies-section"><a class="docs-heading-anchor" href="#The-dependencies-section">The <code>dependencies</code> section</a><a id="The-dependencies-section-1"></a><a class="docs-heading-anchor-permalink" href="#The-dependencies-section" title="Permalink"></a></h3><p>This section provides a list of external (<em>external</em> here means &quot;not found within the <code>src</code> directory of HARMONIE-AROME&quot;, so, for example, <code>gribex</code> is also an external library for CMake build) libraries required to compile and link HARMONIE-AROME code. Since finding a correct library can be a tricky task, this section allows a number of options for specifying external dependencies:</p><ul><li><p>You can completely rely on CMake and delegate it all the work for finding a dependency. In this case, a dependency is added as a simple string to the <code>dependencies</code> section, for example:</p><pre><code class="language-json hljs">&quot;dependencies&quot;:[&quot;OpenMP&quot;, &quot;LAPACK&quot;]</code></pre><p>This option is for packages like <code>OpenMP</code> which do not involve finding libraries located in unusual places as often happens when using environment modules.</p></li><li><p>You can still rely on CMake to find the package, but provide a bit of detail on how to find it. In this case a dependency is added as a JSON object of the following form (using the <code>NetCDF</code> library as an example):</p><pre><code class="language-json hljs">{
  &quot;pkg&quot;:&quot;NetCDF&quot;,
  &quot;use_cmake_config&quot;:false,
  &quot;components&quot;:[&quot;C&quot;,&quot;Fortran&quot;],
  &quot;hints&quot;:[&quot;$ENV{NETCDF_DIR}&quot;,&quot;$ENV{NETCDF_F_DIR}&quot;],
  &quot;cmake&quot;:{&quot;NETCDF_USE_DEFAULT_PATHS&quot;:true}
}</code></pre><p>There the <code>use_cmake_config</code> field tells CMake which mechanism it should use to find the library in question. When <code>use_cmake_config</code> is set to <code>true</code> CMake will look for CMake configuration files installed with the library, which is a recommended option in modern CMake. Even though it&#39;s a recommended by the CMake authors option, not all the libraries provide CMake configuration files so just setting <code>use_cmake_config</code> to <code>true</code> does not work all the time (at least it works for the auxiliary libraries compiled with CMake). You might want to provide a <code>-D&lt;package name&gt;_DIR=&lt;path to CMake config files&gt;</code> as an argument to the <code>cmake</code> command when configuring the build if CMake fails to find a package.</p><p>Another alternative is setting <code>use_cmake_config</code> to <code>false</code>, then CMake will try to find the required dependency using the hand-written scripts provided by the authors of CMake (or found under the <code>util/cmake</code> directory of HARMONIE-AROME). These scripts usually do quite some work trying to find a dependency and sometimes fail even if library is there, for example when it&#39;s located in a <em>very</em> unusual place or has an unexpected <code>pkg-config</code> name.</p><p>When using <code>&quot;use_cmake_config&quot;:false</code> one may add a <code>components</code> list, if only a language-specific version of the dependency is wanted. For example, having:</p><pre><code class="language-json hljs">{&quot;pkg&quot;:&quot;NetCDF&quot;, &quot;use_cmake_config&quot;:false, &quot;components&quot;:[&quot;C&quot;]}</code></pre><p>CMake would not try to find the Fortran version of NetCDF library, which can be useful sometimes. Use this option of defining external dependencies for such libraries as MPI, which can have multiple vendors and subtle differences between libraries provided (for example CMake should be able to figure out the correct MPI libraries for both MPICH and Open-MPI).</p><p>The <code>hints</code> list tells CMake which directories it should check when looking for a library.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Elements of the <code>hints</code> list are simply added to the <code>&lt;PackageName&gt;_ROOT</code> CMake variable. If CMake&#39;s <code>find_package(&lt;PackageName&gt;)</code> does not use this variable providing <code>hints</code> would have no effect.</p></div></div><p>Finally, the <code>cmake</code> section provides a key-value set of elements, which will be converted to corresponding CMake variables set <strong>before</strong> calling <code>find_package(&lt;PackageName&gt;)</code>. Thus, it can be used to control the behaviour of <code>find_package</code>.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Variables set in the <code>cmake</code> section are local to the current package and do not modify the global scope.</p></div></div></li><li><p>When nothing of the above works, you can provide all the flags manually. To do so, use the following form for a dependency entry:</p><pre><code class="language-json hljs">{
  &quot;pkg&quot;:&quot;HDF5&quot;,
  &quot;raw_lib&quot;:{
    &quot;include&quot;:&quot;$ENV{HDF5_DIR}/include&quot;,
    &quot;lib_directory&quot;:&quot;$ENV{HDF5_DIR}/lib&quot;,
    &quot;lib&quot;:[&quot;-lhdf5hl_fortran&quot;, &quot;-lhdf5_fortran&quot;, &quot;-lhdf5_hl&quot;, &quot;-lhdf5&quot;]
  }
}</code></pre><p>where the <code>raw_lib</code> component provides all the needed include and link directories as well as the link libraries. If some some fields of the <code>raw_lib</code> object are unneeded they can be set to <code>null</code>:</p><pre><code class="language-json hljs">{&quot;pkg&quot;:&quot;rt&quot;, &quot;raw_lib&quot;:{&quot;include&quot;:null, &quot;lib_directory&quot;:null, &quot;lib&quot;:&quot;-lrt&quot;}}</code></pre><p>Note that all the members of the <code>raw_lib</code> object can be defined as lists:</p><pre><code class="language-json hljs">{
  &quot;pkg&quot;:&quot;HDF5&quot;,
  &quot;raw_lib&quot;:{
    &quot;include&quot;:[&quot;$ENV{HDF5_DIR}/include&quot;,&quot;$ENV{HDF5_DIR}/include_fortran&quot;],
    &quot;lib_directory&quot;:[&quot;$ENV{HDF5_DIR}/lib&quot;,&quot;$ENV{HDF5_DIR}/lib64&quot;],
    &quot;lib&quot;:[&quot;-lhdf5hl_fortran&quot;, &quot;-lhdf5_fortran&quot;, &quot;-lhdf5_hl&quot;, &quot;-lhdf5&quot;]
  }
}</code></pre><p>When providing the required libraries in the <code>lib</code> section one can skip the <code>-l</code> prefix, thus having <code>&quot;lib&quot;:&quot;-lrt&quot;</code> and <code>&quot;lib&quot;:&quot;rt&quot;</code> would have the same effect.</p></li><li><p>Sometimes it can be useful to define a dummy library in CMake without actually looking for the library files, for example when compiling a tool which uses only a subset of HARMONIE-AROME libraries. When loading HARMONIE-AROME as a CMake package all the targets associated with external dependencies should be present, but some of these dependencies might be not needed for successful linking (or these are added implicitly by the programming environment and adding them for the second time in CMake won&#39;t make any difference). In this case you can use the following:</p><pre><code class="language-json hljs">{&quot;pkg&quot;:&quot;gribex&quot;,  &quot;dummy&quot;:true}</code></pre></li></ul><h3 id="The-programs-section"><a class="docs-heading-anchor" href="#The-programs-section">The <code>programs</code> section</a><a id="The-programs-section-1"></a><a class="docs-heading-anchor-permalink" href="#The-programs-section" title="Permalink"></a></h3><p>This section provides a list of HARMONIE-AROME programs to build (excluding <code>MASTERODB</code> which is always built by the CMake build system), for example:</p><pre><code class="language-json hljs">&quot;programs&quot;:[&quot;BATOR&quot;, &quot;oulan&quot;, &quot;ioassign&quot;, &quot;LSMIX&quot;]</code></pre><p>CMake will try to find the corresponding Fortran source files and will complain if unable to do so. Currently it is not possible to explicitly tell CMake via JSON config which program should be compiled from which source file. If CMake is unable to figure out how to compile a program the CMake-code should be altered to tell it how to do so.</p><h3 id="The-configure-section"><a class="docs-heading-anchor" href="#The-configure-section">The <code>configure</code> section</a><a id="The-configure-section-1"></a><a class="docs-heading-anchor-permalink" href="#The-configure-section" title="Permalink"></a></h3><p>This section provides various configure-time flags controlling the build system or selecting features. Currently in the main HARMONIE-AROME config file this section is defined as follows:</p><pre><code class="language-json hljs">&quot;configure&quot;:{
    &quot;use_flexfix&quot;:true
  , &quot;precision&quot;:&quot;double&quot;
},</code></pre><p>There the <code>use_flexfix</code> option controls the usage of the <code>flexfix</code> wrapper, set it to <code>true</code> to use the <code>flexfix</code> wrapper when generating lexers for the Blacklist and ODB compilers. Having <code>use_flexfix</code> as <code>false</code> results in using the <code>flex</code> tool directly. The <code>precision</code> option controls the floating point precision of the build, with possible values of <code>double</code> and <code>single</code>. This is a mandatory option, removing it would result in a CMake fatal error at the configure time.</p><p>The configure file for <code>gl</code> has the following options in the <code>configure</code> section:</p><pre><code class="language-json hljs">&quot;configure&quot;:{
    &quot;use_aladin&quot;:true
  , &quot;use_netcdf&quot;:true
  , &quot;check_preferlocalconcepts_bug&quot;:true
}</code></pre><p>Set <code>use_aladin</code> to <code>true</code> to compile with FA support (requires HARMONIE-AROME libraries). Set <code>use_netcdf</code> to <code>true</code> to enable NetCDF support in <code>gl</code>. Set <code>check_preferlocalconcepts_bug</code> to <code>true</code> to perform a configure-time auto-detection test checking whether the supplied eccodes version is affected by the <a href="https://jira.ecmwf.int/browse/ECC-1200">preferLocalConcepts bug</a>. This test can be skipped, although in such a case corresponding CPP definitions should be manually added to the config file if a &#39;bad&#39; eccodes version is used.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>If an option is removed from the <code>configure</code> section it will be treated by CMake as set to <code>false</code> in case of boolean flags or empty string for string options.</p></div></div><h4 id="Adding-a-new-configure-option"><a class="docs-heading-anchor" href="#Adding-a-new-configure-option">Adding a new <code>configure</code> option</a><a id="Adding-a-new-configure-option-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-a-new-configure-option" title="Permalink"></a></h4><p>There&#39;s no predefined list of <code>configure</code> section members of CMake JSON config, any element found in this section will be available as <code>CONFIG_&lt;option name&gt;</code> from CMake code. For example having:</p><pre><code class="language-json hljs">&quot;configure&quot;:{
    &quot;use_flexfix&quot;:true
  , &quot;precision&quot;:&quot;double&quot;
  , &quot;new_flag&quot;:true
},</code></pre><p>would define the following variables available in CMake scripts (after call to the <code>hm_get_json_configure_options</code> function): <code>CONFIG_USE_FLEXFIX</code>, <code>CONFIG_PRECISION</code> and <code>CONFIG_NEW_FLAG</code>. How these newly introduced options are used when configuring the build is up to the developer.</p><h3 id="The-compile-section"><a class="docs-heading-anchor" href="#The-compile-section">The <code>compile</code> section</a><a id="The-compile-section-1"></a><a class="docs-heading-anchor-permalink" href="#The-compile-section" title="Permalink"></a></h3><p>This section defines compiler flags and preprocessor definitions which should be used when compiling various components of HARMONIE-AROME. Generally this section should consists of a list of objects with the following structure where the first of these objects should always have the project name set to <code>null</code>:</p><pre><code class="language-json hljs">{
    &quot;project&quot;:null
  , &quot;flags_fortran&quot;:{&quot;any&quot;:[], &quot;debug&quot;:[], &quot;release&quot;:[]}
  , &quot;flags_c&quot;:[]
  , &quot;defs_fortran&quot;:[]
  , &quot;defs_c&quot;:[]
  , &quot;exclusive_defs&quot;:true
  , &quot;exclusive_flags&quot;:true
},</code></pre><p>Individual members of these objects are defined as follows:</p><ul><li><p><code>project</code> is the name of the CMake target for which the provided setting should be applied. CMake matches this field against the names of its targets, which means that having, for example, <code>&quot;project&quot;:&quot;surf&quot;</code> would apply the compilation flags for all CMake targets named <code>surf</code> or with names starting with <code>surf-</code>, as in <code>surf-module</code>. When CMake finds a suitable project-specific section it will append project-specific compilation flags to the global compilation flags for the project in question (if not explicitly asked to not use global flags). If there&#39;s no suitable section with project-specific options, only the global options will be used.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>All compilation flags and preprocessor definitions should be set via JSON config and not through the native CMake variables.</p></div></div></li><li><p><code>flags_fortran</code> define compiler flags to be used when compiling Fortran source files. Flags can be defined in three different ways: as a string (e.g., <code>&quot;flags_fortran&quot;:&quot;-std=f2003&quot;</code>), as a list (e.g., <code>&quot;flags_fortran&quot;:[&quot;-std=f2003&quot;, &quot;-Wall&quot;]</code>) or as an object. Providing the compiler flags as a JSON object allows for a fine-grained control applying different flags for different build configurations (the first two forms will apply the same flags for any build configuration). This object contains three subsections: <code>any</code>, <code>debug</code> and <code>release</code>. Compiler flags put under the <code>any</code> section will be used for any build type, while flags under <code>debug</code> and <code>release</code> will be used only when <code>CMAKE_BUILD_TYPE</code> is set to <code>Debug</code> or <code>Release</code>, respectively. Thus if having, for example, <code>&quot;flags_fortran&quot;:{&quot;any&quot;:[&quot;-std=f2003&quot;], &quot;debug&quot;:[&quot;-O0&quot;], &quot;release&quot;:[&quot;-O2&quot;]}</code> Fortran sources will be compiled using <code>-std=f2003 -O0</code> when <code>CMAKE_BUILD_TYPE=Debug</code> and <code>-std=f2003 -O2</code> when <code>CMAKE_BUILD_TYPE=Release</code>.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Technically, the compiler flags there are not limited to the <code>debug</code> and <code>release</code> configurations. CMake allows defining custom <code>CMAKE_BUILD_TYPE</code> and it will look for a correspondingly named element under the <code>flags_fortran</code> object. However, this feature is not used in the current version of CMake-based build system for HARMONIE-AROME</p></div></div><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Compiler flags there can be provided as a list (e.g., <code>[&quot;-Wall&quot;, &quot;-Wextra&quot;]</code>) or as a plain string when there is only a single flag (e.g., <code>&quot;flags_fortran&quot;:&quot;-O2&quot;</code>) but <strong>never</strong> as a space-separated string with multiple compiler flags. Trying to do so will result in an error.</p></div></div></li><li><p><code>flags_c</code> same as <code>flags_fortran</code> but for compiling C code.</p></li><li><p><code>defs_fortran</code> defined in the same way as <code>flags_fortran</code> (allowing the same three forms: a string, a list or an object) but contains preprocessor definitions.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Preprocessor definitions should be added without the <code>-D</code> prefix, for example: <code>&quot;defs_fortran&quot;:{&quot;debug&quot;:&quot;PRINT_MORE&quot;}</code> and not as <code>defs_fortran&quot;:{&quot;debug&quot;:&quot;-DPRINT_MORE&quot;}</code>.</p></div></div></li><li><p><code>defs_c</code> same as <code>defs_fortran</code> but for the C code.</p></li><li><p><code>exclusive_defs</code> and <code>exclusive_flags</code> flags. In some situations it can be useful to ignore the global compilation flags defined by <code>&quot;project&quot;:null</code> and use only project-specific flags or preprocessor definitions. To do so, add <code>exclusive_defs</code> and/or <code>exclusive_flags</code> to the project-specific element of the <code>compile</code> section, for example having:</p><pre><code class="language-json hljs">  {
      &quot;project&quot;:null
    , &quot;flags_fortran&quot;:&quot;-Wall&quot;
  },
  {
      &quot;project&quot;:&quot;gribex&quot;
    , &quot;exclusive_defs&quot;:true
    , &quot;exclusive_flags&quot;:true
    , &quot;flags_fortran&quot;:&quot;-O0&quot;
  },
  {
      &quot;project&quot;:&quot;surfex&quot;
    , &quot;flags_fortran&quot;:&quot;-O0&quot;
  }</code></pre><p>will result in having <code>gribex</code> to be always compiled with just <code>-O0</code> without using any other flags or preprocessor definitions, but <code>surfex</code> will be compiled with <code>-Wall -O0</code>.</p></li></ul><h3 id="The-compile_single-and-compile_double-sections"><a class="docs-heading-anchor" href="#The-compile_single-and-compile_double-sections">The <code>compile_single</code> and <code>compile_double</code> sections</a><a id="The-compile_single-and-compile_double-sections-1"></a><a class="docs-heading-anchor-permalink" href="#The-compile_single-and-compile_double-sections" title="Permalink"></a></h3><p>These sections repeat the structure of the <code>compile</code> section. Compiler flags defined by these sections are appended to the flags defined in the <code>compile</code> section of the config based on the value of the value of the <code>precision</code> flag from the <code>configure</code> section.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Do not add auto-double flags (e.g., GNU Fortran&#39;s <code>-fdefault-real-8</code>) there, they are handled differently.</p></div></div><h3 id="The-custom_compile-section"><a class="docs-heading-anchor" href="#The-custom_compile-section">The <code>custom_compile</code> section</a><a id="The-custom_compile-section-1"></a><a class="docs-heading-anchor-permalink" href="#The-custom_compile-section" title="Permalink"></a></h3><p>Sometimes it might be desirable to add some specific compile flags for a single source file. This can be achieved by using the <code>custom_compile</code> section of JSON config as follows:</p><pre><code class="language-json hljs">&quot;custom_compile&quot;:{
  &quot;sufpf.F90&quot;:[&quot;-O0&quot;, &quot;-Wextra&quot;]
},</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Unlike <code>makeup</code>, compilation flags found in the <code>custom_compile</code> are always appended to the list of compiler flags for the specified source file and there&#39;s no option to replace them.</p></div></div><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>When using the <code>Unix Makefiles</code> generator, per-source compile flags are set on the target level. Thus, for example, adding (or updating) a custom compile flag for a  source file within <code>arpifs</code> will result in recompilation of the whole <code>arpifs</code> project. The <code>Ninja</code> generator does not have such limitation, and only the source file in question will be recompiled (possibly triggering a recompilation cascade if other Fortran sources depend on it).</p></div></div><h3 id="The-link-section"><a class="docs-heading-anchor" href="#The-link-section">The <code>link</code> section</a><a id="The-link-section-1"></a><a class="docs-heading-anchor-permalink" href="#The-link-section" title="Permalink"></a></h3><p>This section provides a list of linker flags to be used when linking HARMONIE-AROME executables, for example:</p><pre><code class="language-json hljs">&quot;link&quot;:[&quot;LINKER:-export-dynamic,--as-needed&quot;, &quot;-rdynamic&quot;]</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>All flags that should be passed directly to <code>ld</code> can be grouped in strings of the following form <code>&quot;LINKER:-option1,-option2&quot;</code> and CMake will figure out how to pass them to the linker.</p></div></div><h2 id="Using-environment-variables-in-JSON-configuration-files"><a class="docs-heading-anchor" href="#Using-environment-variables-in-JSON-configuration-files">Using environment variables in JSON configuration files</a><a id="Using-environment-variables-in-JSON-configuration-files-1"></a><a class="docs-heading-anchor-permalink" href="#Using-environment-variables-in-JSON-configuration-files" title="Permalink"></a></h2><p>Current version of CMake JSON config implemented in HARMONIE-AROME allows using environment variables as <code>$ENV{VARIABLE}</code> in the following contexts:</p><ul><li>string-valued members of the <code>configure</code> section, e.g., <code>&quot;configure&quot;:{&quot;precision&quot;:&quot;$ENV{VARIABLE}&quot;}</code></li><li>any elements of JSON config which allow a list of strings as one of the possible values, for example:<ul><li><code>&quot;link&quot;:[&quot;LINKER:-export-dynamic,--as-needed&quot;, &quot;$ENV{VARIABLE}&quot;]</code> works since the <code>link</code> section expects a list of strings</li><li><code>&quot;compile_double&quot;:[{&quot;project&quot;:null, &quot;defs_fortran&quot;:&quot;$ENV{VARIABLE}&quot;}]</code> also works because <code>defs_fortran</code> allows a list of strings as an option</li><li><code>{&quot;pkg&quot;:&quot;$ENV{VARIABLE}&quot;,&quot;use_cmake_config&quot;:true}</code> <strong>does not work</strong> because <code>pkg</code> is expected to provide a single string</li></ul></li></ul><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Currently CMake recognises only the first <code>$ENV{VAR}</code> when reading a JSON string. Thus, having <code>&quot;include&quot;:&quot;$ENV{HDF5_DIR}/include&quot;</code> works as expected, but <code>&quot;include&quot;:&quot;$ENV{HDF5_DIR}/$ENV{PRG_ENV}/include&quot;</code> would keep the second <code>$ENV</code> as it is. This is not CMake&#39;s limitation, but rather a technical detail of the current JSON config for HARMONIE-AROME, which can be changed in the future, if desired.</p></div></div><h2 id="Note-on-the-structure-of-the-JSON-configuration-files"><a class="docs-heading-anchor" href="#Note-on-the-structure-of-the-JSON-configuration-files">Note on the structure of the JSON configuration files</a><a id="Note-on-the-structure-of-the-JSON-configuration-files-1"></a><a class="docs-heading-anchor-permalink" href="#Note-on-the-structure-of-the-JSON-configuration-files" title="Permalink"></a></h2><p>The structure of JSON-based configuration files is not automagically understood by CMake, there is some boilerplate code to be added to CMake scripts. Thus, the described structure of the CMake config file fully applies only to the main build. Other components of the system try to use the same structure of the config file, but some sections might be not handled correctly yet (for example, if a project does not use configure-time flags adding a <code>configure</code> section without modifying the CMake code would not have any effect and corresponding CMake variable won&#39;t be added).</p><h2 id="Note-on-the-auto-double-flags"><a class="docs-heading-anchor" href="#Note-on-the-auto-double-flags">Note on the auto-double flags</a><a id="Note-on-the-auto-double-flags-1"></a><a class="docs-heading-anchor-permalink" href="#Note-on-the-auto-double-flags" title="Permalink"></a></h2><p>The compiler flags defining the preferred precision of the floating point variables in CMake build for HARMONIE-AROME are provided on the per-compiler and not per-config level. Thus, for each compiler type recognized by CMake a file named as <code>FortranCompilerFlags.&lt;compiler type&gt;.cmake</code> should be added to the <code>util/cmake</code> directory. This file should define the following CMake variables <code>Fortran_DEFAULT_FLOAT_32</code>, <code>Fortran_DEFAULT_FLOAT_64</code>, <code>Fortran_DEFAULT_INT_32</code>, <code>Fortran_DEFAULT_INT_64</code> (some of them may be empty if a compiler does not provide corresponding flags). For example for the GNU compilers <code>FortranCompilerFlags.GNU.cmake</code> is defined as:</p><pre><code class="language-cmake hljs">set(Fortran_DEFAULT_FLOAT_32 &quot;&quot;)
set(Fortran_DEFAULT_FLOAT_64 &quot;-fdefault-double-8 -fdefault-real-8&quot;)

set(Fortran_DEFAULT_INT_32   &quot;&quot;)
set(Fortran_DEFAULT_INT_64   &quot;-fdefault-integer-8&quot;)</code></pre><p>When running cmake configure, and depending on the build precision, a subset of these flags is added to the <code>CMAKE_Fortran_FLAGS</code> variable thus affecting <strong>all</strong> the Fortran targets. Currently, <code>DEFAULT_INT</code> variables are not used in CMake build, but are provided for consistency.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>When creating <code>FortranCompilerFlags.&lt;compiler type&gt;.cmake</code>, <code>&lt;compiler type&gt;</code> should follow the naming provided by <code>CMAKE_Fortran_COMPILER_ID</code>, for example, <code>GNU</code> for gfortran and <code>Intel</code> for ifort. See the <a href="https://cmake.org/cmake/help/latest/variable/CMAKE_LANG_COMPILER_ID.html">CMake documentation</a> for a list of all supported compiler vendors.</p></div></div><h2 id="Note-on-generating-different-build-systems-with-CMake"><a class="docs-heading-anchor" href="#Note-on-generating-different-build-systems-with-CMake">Note on generating different build systems with CMake</a><a id="Note-on-generating-different-build-systems-with-CMake-1"></a><a class="docs-heading-anchor-permalink" href="#Note-on-generating-different-build-systems-with-CMake" title="Permalink"></a></h2><p>CMake is a build system generator and it can create different <em>native</em> build systems from the same <code>CMakeLists.txt</code>. The full list of supported generators is available in the <a href="https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html">CMake documentation</a>, however in practice when building HARMONIE-AROME on a Linux machine (or on a UNIX-like one in general) there are two options: the <code>Unix Makefiles</code> generator and the <code>Ninja</code> generator:</p><ul><li><p><code>Unix Makefiles</code> generator produces a build system based on the standard makefiles and does not use &quot;exotic&quot; tools. This is a default generator for CMake running on Linux and it usually works pretty well. However, when building with <code>Unix Makefiles</code>, CMake relies on its own Fortran parsers to scan the source tree and determine the build dependencies. Thus, in some rare cases of heavy CPP usage in Fortran code CMake can get inter-module dependencies wrong. The <code>Unix Makefiles</code> build is not parallel by default but it can be controlled, as with any conventional makefile-based build, by passing the desired <code>-j</code> flags to <code>make</code>. Additionally, when invoking the build via <code>cmake --build</code> command, a <code>-j</code> (or <code>--parallel</code>) flag can be used for setting the number of parallel jobs in a build-system-agnostic way, see <a href="https://cmake.org/cmake/help/latest/manual/cmake.1.html#build-a-project">CMake documentation</a>.</p></li><li><p><code>Ninja</code> is a modern alternative to Make. Ninja is built with focus on speed and Ninja build is parallel by default, however, unlike Make, the build files for Ninja are very cumbersome to hand-write and they are usually machine-generated. When building Fortran code with CMake Ninja generator, an explicit preprocessing step is added, thus the inter-module dependencies should be always correct (or at least these corner cases where <code>Unix Makefiles</code> struggles to get correct dependencies are handled correctly by Ninja). In some cases using <code>Ninja</code> generator can reduce the build time due to better parallelization of the build, however since Ninja has a separate preprocessing step, it generates more output and, if the file system is a bottleneck, Ninja build can be slower than Unix Makefiles build. Using the <code>Ninja</code> generator in CMake requires the <code>ninja</code> tool to be available in the <code>$PATH</code> at the configure time.</p></li></ul><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Specific CMake generator can be selected at the configure time by passing the correct <code>-G &lt;gen&gt;</code> flag to cmake. For example, <code>cmake -G Ninja &lt;...other CMake args...&gt;</code> or <code>cmake -G &quot;Unix Makefiles&quot; &lt;...other CMake args...&gt;</code>.</p></div></div><h2 id="Practical-considerations"><a class="docs-heading-anchor" href="#Practical-considerations">Practical considerations</a><a id="Practical-considerations-1"></a><a class="docs-heading-anchor-permalink" href="#Practical-considerations" title="Permalink"></a></h2><h3 id="When-to-re-run-CMake-configure-in-my-experiment?"><a class="docs-heading-anchor" href="#When-to-re-run-CMake-configure-in-my-experiment?">When to re-run CMake configure in my experiment?</a><a id="When-to-re-run-CMake-configure-in-my-experiment?-1"></a><a class="docs-heading-anchor-permalink" href="#When-to-re-run-CMake-configure-in-my-experiment?" title="Permalink"></a></h3><p>In principle, it should be enough to run CMake configure only once to generate the build system and after that any modification of the source code or configuration files should be detected by the build system triggering the required re-build steps. The only time, when CMake configure should be explicitly re-run is when you add a new source file to HARMONIE-AROME. The current implementation of the CMake build scans the file system looking for the source files to compile, so just putting a new file under, say, <code>src/surfex/SURFEX/</code> and re-running the build isn&#39;t enough since this new file would be still unknown to the build system, thus the need of rerunning the configure step first.</p><h3 id="I-added-some-code-and-CMake-build-stopped-working"><a class="docs-heading-anchor" href="#I-added-some-code-and-CMake-build-stopped-working">I added some code and CMake build stopped working</a><a id="I-added-some-code-and-CMake-build-stopped-working-1"></a><a class="docs-heading-anchor-permalink" href="#I-added-some-code-and-CMake-build-stopped-working" title="Permalink"></a></h3><p>Unlike <code>makeup</code>, CMake build for HARMONIE-AROME enforces inter-project boundaries and each project has an explicit list of its dependencies. For example, it is not possible to use modules from <code>arpifs</code> in <code>surfex</code>, but it is possible to use <code>mse</code> modules. If after a code modification CMake starts complaining about missing module files, then it means that this modification violates the project dependencies in the build. To fix this problem, please update your changeset to use only the available modules. If you believe that your modification is sound with respect to inter-project dependencies of HARMONIE-AROME and it&#39;s the CMake build which misses a dependency, please open a new GitHub issue explaining the problem.</p><h3 id="Can-I-move/copy-my-build-directory-to-another-directory-and-re-use-it?"><a class="docs-heading-anchor" href="#Can-I-move/copy-my-build-directory-to-another-directory-and-re-use-it?">Can I move/copy my build directory to another directory and re-use it?</a><a id="Can-I-move/copy-my-build-directory-to-another-directory-and-re-use-it?-1"></a><a class="docs-heading-anchor-permalink" href="#Can-I-move/copy-my-build-directory-to-another-directory-and-re-use-it?" title="Permalink"></a></h3><p>No, it&#39;s generally a bad idea. CMake loves absolute paths and uses them in many parts of the generated build system, thus simply moving the build directory would break the build.</p><h3 id="Something-went-wrong-and-CMake-doesn&#39;t-behave-anymore,-can-I-refresh-the-build-without-nuking-the-whole-build-directory?"><a class="docs-heading-anchor" href="#Something-went-wrong-and-CMake-doesn&#39;t-behave-anymore,-can-I-refresh-the-build-without-nuking-the-whole-build-directory?">Something went wrong and CMake doesn&#39;t behave anymore, can I refresh the build without nuking the whole build directory?</a><a id="Something-went-wrong-and-CMake-doesn&#39;t-behave-anymore,-can-I-refresh-the-build-without-nuking-the-whole-build-directory?-1"></a><a class="docs-heading-anchor-permalink" href="#Something-went-wrong-and-CMake-doesn&#39;t-behave-anymore,-can-I-refresh-the-build-without-nuking-the-whole-build-directory?" title="Permalink"></a></h3><p>You can try deleting just the <code>CMakeCache.txt</code> file from the build directory.</p><h3 id="CMake-picks-a-wrong-compiler"><a class="docs-heading-anchor" href="#CMake-picks-a-wrong-compiler">CMake picks a wrong compiler</a><a id="CMake-picks-a-wrong-compiler-1"></a><a class="docs-heading-anchor-permalink" href="#CMake-picks-a-wrong-compiler" title="Permalink"></a></h3><p>Sometimes CMake selects a system default compiler instead of the compiler provided, for example, by loading a module. There are a few options available to force CMake to use a specific compiler, a straightforward one is to set the compiler via commonly-used environment variables (for example, <code>export FC=ifort</code> for a Fortran compiler). Another way, is to set the correct compilers in command-line arguments when configuring the CMake build (for example adding <code>-DCMAKE_Fortran_COMPILER=ifort</code> to the list of CMake arguments). CMake recognizes <code>CMAKE_&lt;LANG&gt;_COMPILER</code> passed from the command line where <code>&lt;LANG&gt;</code> can be <code>Fortran</code>, <code>C</code> or <code>CXX</code>.</p><h3 id="Can-I-get-more-verbose-output-when-compiling-with-CMake?"><a class="docs-heading-anchor" href="#Can-I-get-more-verbose-output-when-compiling-with-CMake?">Can I get more verbose output when compiling with CMake?</a><a id="Can-I-get-more-verbose-output-when-compiling-with-CMake?-1"></a><a class="docs-heading-anchor-permalink" href="#Can-I-get-more-verbose-output-when-compiling-with-CMake?" title="Permalink"></a></h3><p>To get detailed information about individual steps and commands issued when compiling HARMONIE-AROME with CMake add <code>-v</code> to your build command:</p><pre><code class="language-bash hljs">cmake --build . --target install -v</code></pre><h3 id="Is-there-a-way-to-visualise-dependencies-between-individual-targets-of-HARMONIE-AROME-in-CMake-build?"><a class="docs-heading-anchor" href="#Is-there-a-way-to-visualise-dependencies-between-individual-targets-of-HARMONIE-AROME-in-CMake-build?">Is there a way to visualise dependencies between individual targets of HARMONIE-AROME in CMake build?</a><a id="Is-there-a-way-to-visualise-dependencies-between-individual-targets-of-HARMONIE-AROME-in-CMake-build?-1"></a><a class="docs-heading-anchor-permalink" href="#Is-there-a-way-to-visualise-dependencies-between-individual-targets-of-HARMONIE-AROME-in-CMake-build?" title="Permalink"></a></h3><p>Since all the inter-target dependencies are defined in CMake scripts it can be useful to have an option to produce a graphical overview of the dependency graph of HARMONIE-AROME without grepping all the <code>CMakeLists.txt</code> files. This can be achieved by adding the <code>--graphviz=&lt;output file name&gt;</code> to the list of CMake arguments, for example:</p><pre><code class="language-bash hljs">cmake $HM_LIB/src --graphviz=harmonie.dot</code></pre><p>then the produced dependency graph can be visualized using the <code>dot</code> tool:</p><pre><code class="language-bash hljs">dot -Tx11 harmonie.dot</code></pre><p>The full dependency graph may be very cluttered and take quite some time to render, so it might be a good idea to plot dependencies of a single target, for example:</p><pre><code class="language-bash hljs">dot -Tx11 harmonie.dot.surf-static</code></pre><p>See the <a href="https://cmake.org/cmake/help/latest/module/CMakeGraphVizOptions.html">CMake documentation on graphviz</a> for additional information about fine-tuning of the generated graphs.</p><h3 id="I-need-more-information-about-CMake,-where-do-I-find-documentation?"><a class="docs-heading-anchor" href="#I-need-more-information-about-CMake,-where-do-I-find-documentation?">I need more information about CMake, where do I find documentation?</a><a id="I-need-more-information-about-CMake,-where-do-I-find-documentation?-1"></a><a class="docs-heading-anchor-permalink" href="#I-need-more-information-about-CMake,-where-do-I-find-documentation?" title="Permalink"></a></h3><p><a href="https://cmake.org/cmake/help/latest/">CMake documentation portal</a> is a great source of detailed information about the various aspects of the CMake build system.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Build_with_makeup/">Â« Makeup</a><a class="docs-footer-nextpage" href="../gmkpack/">Gmkpack Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.19 on <span class="colophon-date" title="Tuesday 28 June 2022 15:47">Tuesday 28 June 2022</span>. Using Julia version 1.6.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
